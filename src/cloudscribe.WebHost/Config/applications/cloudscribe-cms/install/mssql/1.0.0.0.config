 
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[mp_ModuleDefinitionSettings](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[ModuleDefID] [int] NOT NULL,
	[SettingName] [nvarchar](50) NOT NULL,
	[SettingValue] [nvarchar](max) NULL,
	[ControlType] [nvarchar](50) NULL,
	[RegexValidationExpression] [nvarchar](max) NULL,
	[FeatureGuid] [uniqueidentifier] NOT NULL,
	[ResourceFile] [nvarchar](255) NULL,
	[ControlSrc] [nvarchar](255) NULL,
	[SortOrder] [int] NOT NULL,
	[HelpKey] [nvarchar](255) NULL,
	[GroupName] [nvarchar](255) NULL,
 CONSTRAINT [PK_mp_ModuleDefinitionSettings_1] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF),
 CONSTRAINT [IX_mp_ModuleDefinitionSettings] UNIQUE NONCLUSTERED 
(
	[ModuleDefID] ASC,
	[SettingName] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF)
)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ModuleDefGroup] ON [dbo].[mp_ModuleDefinitionSettings] 
(
	[GroupName] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ModuleDefSetDefId] ON [dbo].[mp_ModuleDefinitionSettings] 
(
	[ModuleDefID] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ModuleDefSetSetName] ON [dbo].[mp_ModuleDefinitionSettings] 
(
	[SettingName] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[mp_ContentRating](
	[RowGuid] [uniqueidentifier] NOT NULL,
	[SiteGuid] [uniqueidentifier] NOT NULL,
	[ContentGuid] [uniqueidentifier] NOT NULL,
	[UserGuid] [uniqueidentifier] NOT NULL,
	[EmailAddress] [nvarchar](100) NULL,
	[Rating] [int] NOT NULL,
	[Comments] [nvarchar](max) NULL,
	[IpAddress] [nvarchar](50) NULL,
	[CreatedUtc] [datetime] NOT NULL,
	[LastModUtc] [datetime] NOT NULL,
 CONSTRAINT [PK_mp_ContentRating] PRIMARY KEY CLUSTERED 
(
	[RowGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF)
)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ContentRatingContentGuid] ON [dbo].[mp_ContentRating] 
(
	[ContentGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ContentRatingIPAddr] ON [dbo].[mp_ContentRating] 
(
	[IpAddress] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ContentRatingSiteGuid] ON [dbo].[mp_ContentRating] 
(
	[SiteGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ContentRatingUserGuid] ON [dbo].[mp_ContentRating] 
(
	[UserGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[mp_ModuleDefinitions](
	[ModuleDefID] [int] IDENTITY(1,1) NOT NULL,
	[FeatureName] [nvarchar](255) NOT NULL,
	[ControlSrc] [nvarchar](255) NOT NULL,
	[SortOrder] [int] NOT NULL,
	[IsAdmin] [bit] NOT NULL,
	[Icon] [nvarchar](255) NULL,
	[DefaultCacheTime] [int] NOT NULL,
	[Guid] [uniqueidentifier] NOT NULL,
	[ResourceFile] [nvarchar](255) NULL,
	[IsCacheable] [bit] NULL,
	[IsSearchable] [bit] NULL,
	[SearchListName] [nvarchar](255) NULL,
	[SupportsPageReuse] [bit] NULL,
	[DeleteProvider] [nvarchar](255) NULL,
	[PartialView] [nvarchar](255) NULL,
 CONSTRAINT [PK_ModuleDefinitions] PRIMARY KEY CLUSTERED 
(
	[ModuleDefID] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF)
)
GO
CREATE NONCLUSTERED INDEX [idxModuleDefGuid] ON [dbo].[mp_ModuleDefinitions] 
(
	[Guid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ModuleDefinitions] ON [dbo].[mp_ModuleDefinitions] 
(
	[Guid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[mp_CategoryItem](
	[Guid] [uniqueidentifier] NOT NULL,
	[SiteGuid] [uniqueidentifier] NOT NULL,
	[FeatureGuid] [uniqueidentifier] NOT NULL,
	[ModuleGuid] [uniqueidentifier] NOT NULL,
	[ItemGuid] [uniqueidentifier] NOT NULL,
	[CategoryGuid] [uniqueidentifier] NOT NULL,
	[ExtraGuid] [uniqueidentifier] NOT NULL,
 CONSTRAINT [PK_mp_CategoryItem] PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF)
)
GO
CREATE NONCLUSTERED INDEX [IX_mp_CategoryItem] ON [dbo].[mp_CategoryItem] 
(
	[ModuleGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_CategoryItem_1] ON [dbo].[mp_CategoryItem] 
(
	[FeatureGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_CategoryItem_2] ON [dbo].[mp_CategoryItem] 
(
	[ExtraGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_CategoryItem_3] ON [dbo].[mp_CategoryItem] 
(
	[ItemGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[mp_Comments](
	[Guid] [uniqueidentifier] NOT NULL,
	[ParentGuid] [uniqueidentifier] NOT NULL,
	[SiteGuid] [uniqueidentifier] NOT NULL,
	[FeatureGuid] [uniqueidentifier] NOT NULL,
	[ModuleGuid] [uniqueidentifier] NOT NULL,
	[ContentGuid] [uniqueidentifier] NOT NULL,
	[UserGuid] [uniqueidentifier] NOT NULL,
	[Title] [nvarchar](255) NULL,
	[UserComment] [nvarchar](max) NOT NULL,
	[UserName] [nvarchar](50) NOT NULL,
	[UserEmail] [nvarchar](100) NOT NULL,
	[UserUrl] [nvarchar](255) NULL,
	[UserIp] [nvarchar](50) NOT NULL,
	[CreatedUtc] [datetime] NOT NULL,
	[LastModUtc] [datetime] NOT NULL,
	[ModerationStatus] [tinyint] NOT NULL,
	[ModeratedBy] [uniqueidentifier] NOT NULL,
	[ModerationReason] [nvarchar](255) NULL,
 CONSTRAINT [PK_mp_Comments] PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF)
)
GO
CREATE NONCLUSTERED INDEX [IX_mp_Comments] ON [dbo].[mp_Comments] 
(
	[SiteGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_Comments_1] ON [dbo].[mp_Comments] 
(
	[ContentGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_Comments_2] ON [dbo].[mp_Comments] 
(
	[FeatureGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_Comments_3] ON [dbo].[mp_Comments] 
(
	[ModuleGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_Comments_4] ON [dbo].[mp_Comments] 
(
	[ParentGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[mp_ContentMeta](
	[Guid] [uniqueidentifier] NOT NULL,
	[SiteGuid] [uniqueidentifier] NOT NULL,
	[ModuleGuid] [uniqueidentifier] NOT NULL,
	[ContentGuid] [uniqueidentifier] NOT NULL,
	[Name] [nvarchar](255) NOT NULL,
	[Scheme] [nvarchar](255) NOT NULL,
	[LangCode] [nvarchar](10) NULL,
	[Dir] [nvarchar](3) NULL,
	[MetaContent] [nvarchar](max) NULL,
	[SortRank] [int] NOT NULL,
	[CreatedUtc] [datetime] NOT NULL,
	[CreatedBy] [uniqueidentifier] NOT NULL,
	[LastModUtc] [datetime] NOT NULL,
	[LastModBy] [uniqueidentifier] NOT NULL,
 CONSTRAINT [PK_mp_ContentMeta] PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF)
)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ContentMeta] ON [dbo].[mp_ContentMeta] 
(
	[SiteGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ContentMeta_1] ON [dbo].[mp_ContentMeta] 
(
	[ModuleGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ContentMeta_2] ON [dbo].[mp_ContentMeta] 
(
	[ContentGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[mp_ContentMetaLink](
	[Guid] [uniqueidentifier] NOT NULL,
	[SiteGuid] [uniqueidentifier] NOT NULL,
	[ModuleGuid] [uniqueidentifier] NOT NULL,
	[ContentGuid] [uniqueidentifier] NOT NULL,
	[Rel] [nvarchar](255) NOT NULL,
	[Href] [nvarchar](255) NOT NULL,
	[HrefLang] [nvarchar](10) NULL,
	[Rev] [nvarchar](50) NULL,
	[Type] [nvarchar](50) NULL,
	[Media] [nvarchar](50) NULL,
	[SortRank] [int] NOT NULL,
	[CreatedUtc] [datetime] NOT NULL,
	[CreatedBy] [uniqueidentifier] NOT NULL,
	[LastModUtc] [datetime] NOT NULL,
	[LastModBy] [uniqueidentifier] NOT NULL,
 CONSTRAINT [PK_mp_ContentMetaLink] PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF)
)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ContentMetaLink] ON [dbo].[mp_ContentMetaLink] 
(
	[SiteGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ContentMetaLink_1] ON [dbo].[mp_ContentMetaLink] 
(
	[ModuleGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ContentMetaLink_2] ON [dbo].[mp_ContentMetaLink] 
(
	[ContentGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[mp_Category](
	[Guid] [uniqueidentifier] NOT NULL,
	[ParentGuid] [uniqueidentifier] NOT NULL,
	[SiteGuid] [uniqueidentifier] NOT NULL,
	[FeatureGuid] [uniqueidentifier] NOT NULL,
	[ModuleGuid] [uniqueidentifier] NOT NULL,
	[Category] [nvarchar](255) NOT NULL,
	[Description] [nvarchar](max) NULL,
	[ItemCount] [int] NOT NULL,
	[CreatedUtc] [datetime] NOT NULL,
	[CreatedBy] [uniqueidentifier] NOT NULL,
	[ModifiedUtc] [datetime] NOT NULL,
	[ModifiedBy] [uniqueidentifier] NOT NULL,
 CONSTRAINT [PK_mp_Category] PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF)
)
GO
CREATE NONCLUSTERED INDEX [IX_mp_Category] ON [dbo].[mp_Category] 
(
	[ModuleGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_Category_1] ON [dbo].[mp_Category] 
(
	[Category] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_Category_2] ON [dbo].[mp_Category] 
(
	[ParentGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[mp_Tag](
	[Guid] [uniqueidentifier] NOT NULL,
	[SiteGuid] [uniqueidentifier] NOT NULL,
	[FeatureGuid] [uniqueidentifier] NOT NULL,
	[ModuleGuid] [uniqueidentifier] NOT NULL,
	[Tag] [nvarchar](255) NOT NULL,
	[CreatedUtc] [datetime] NOT NULL,
	[CreatedBy] [uniqueidentifier] NOT NULL,
	[ModifiedUtc] [datetime] NOT NULL,
	[ModifiedBy] [uniqueidentifier] NOT NULL,
	[ItemCount] [int] NOT NULL,
	[VocabularyGuid] [uniqueidentifier] NULL,
 CONSTRAINT [PK_mp_Tag] PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF)
)
GO
CREATE NONCLUSTERED INDEX [IX_mp_Tag] ON [dbo].[mp_Tag] 
(
	[Tag] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_Tag_1] ON [dbo].[mp_Tag] 
(
	[ModuleGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_Tag_2] ON [dbo].[mp_Tag] 
(
	[FeatureGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_Tag_3] ON [dbo].[mp_Tag] 
(
	[SiteGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_Tag_VocG] ON [dbo].[mp_Tag] 
(
	[VocabularyGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[mp_TagItem](
	[Guid] [uniqueidentifier] NOT NULL,
	[SiteGuid] [uniqueidentifier] NOT NULL,
	[FeatureGuid] [uniqueidentifier] NOT NULL,
	[ModuleGuid] [uniqueidentifier] NOT NULL,
	[ItemGuid] [uniqueidentifier] NOT NULL,
	[TagGuid] [uniqueidentifier] NOT NULL,
	[ExtraGuid] [uniqueidentifier] NOT NULL,
	[TaggedBy] [uniqueidentifier] NOT NULL,
 CONSTRAINT [PK_mp_TagItem] PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF)
)
GO
CREATE NONCLUSTERED INDEX [IX_mp_TagItem] ON [dbo].[mp_TagItem] 
(
	[ModuleGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_TagItem_1] ON [dbo].[mp_TagItem] 
(
	[TagGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_TagItem_2] ON [dbo].[mp_TagItem] 
(
	[SiteGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_TagItem_3] ON [dbo].[mp_TagItem] 
(
	[FeatureGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_TagItem_4] ON [dbo].[mp_TagItem] 
(
	[ItemGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_TagItem_5] ON [dbo].[mp_TagItem] 
(
	[TaggedBy] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[mp_SiteModuleDefinitions](
	[SiteID] [int] NOT NULL,
	[ModuleDefID] [int] NOT NULL,
	[AuthorizedRoles] [nvarchar](max) NULL,
	[SiteGuid] [uniqueidentifier] NULL,
	[FeatureGuid] [uniqueidentifier] NULL,
 CONSTRAINT [PK_mp_SiteModuleDefinitions] PRIMARY KEY CLUSTERED 
(
	[SiteID] ASC,
	[ModuleDefID] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF)
)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitions_Delete]

    
@ModuleDefID int

AS

DELETE FROM
    mp_ModuleDefinitions

WHERE
    ModuleDefID = @ModuleDefID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_TagItem_Insert]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@Guid uniqueidentifier,
@SiteGuid uniqueidentifier,
@FeatureGuid uniqueidentifier,
@ModuleGuid uniqueidentifier,
@ItemGuid uniqueidentifier,
@TagGuid uniqueidentifier,
@ExtraGuid uniqueidentifier,
@TaggedBy uniqueidentifier

	
AS

INSERT INTO 	[dbo].[mp_TagItem] 
(
				[Guid],
				[SiteGuid],
				[FeatureGuid],
				[ModuleGuid],
				[ItemGuid],
				[TagGuid],
				[ExtraGuid],
				[TaggedBy]
) 

VALUES 
(
				@Guid,
				@SiteGuid,
				@FeatureGuid,
				@ModuleGuid,
				@ItemGuid,
				@TagGuid,
				@ExtraGuid,
				@TaggedBy
				
)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_TagItem_DeleteByTag]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@TagGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_TagItem]
WHERE
	[TagGuid] = @TagGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_TagItem_DeleteBySite]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@SiteGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_TagItem]
WHERE
	[SiteGuid] = @SiteGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_TagItem_DeleteByModule]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@ModuleGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_TagItem]
WHERE
	[ModuleGuid] = @ModuleGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_TagItem_DeleteByItem]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@ItemGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_TagItem]
WHERE
	[ItemGuid] = @ItemGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_TagItem_DeleteByFeature]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@FeatureGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_TagItem]
WHERE
	[FeatureGuid] = @FeatureGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_TagItem_DeleteByExtraGuid]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@ExtraGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_TagItem]
WHERE
	[ExtraGuid] = @ExtraGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_TagItem_Delete]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@Guid uniqueidentifier

AS

DELETE FROM [dbo].[mp_TagItem]
WHERE
	[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Tag_UpdateItemCount]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/
	
@Guid uniqueidentifier



AS

UPDATE 		[dbo].[mp_Tag] 

SET
			ItemCount = (SELECT Count(*) FROM [dbo].mp_TagItem WHERE TagGuid = @Guid)
			
WHERE
			[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Tag_Update]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2012-05-29
*/
	
@Guid uniqueidentifier, 
@VocabularyGuid uniqueidentifier, 
@Tag nvarchar(255), 
@ModifiedUtc datetime, 
@ModifiedBy uniqueidentifier



AS

UPDATE 		[dbo].[mp_Tag] 

SET
			VocabularyGuid = @VocabularyGuid,
			[Tag] = @Tag,
			[ModifiedUtc] = @ModifiedUtc,
			[ModifiedBy] = @ModifiedBy
			
WHERE
			[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Tag_SelectOne]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@Guid uniqueidentifier

AS


SELECT *
			
FROM
		[dbo].[mp_Tag]
		
WHERE
		[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Tag_SelectByModule]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@ModuleGuid uniqueidentifier

AS


SELECT *
			
FROM
		[dbo].[mp_Tag]
		
WHERE
		[ModuleGuid] = @ModuleGuid
ORDER BY Tag
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Tag_Insert]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2012-05-29
*/

@Guid uniqueidentifier,
@VocabularyGuid uniqueidentifier,
@SiteGuid uniqueidentifier,
@FeatureGuid uniqueidentifier,
@ModuleGuid uniqueidentifier,
@Tag nvarchar(255),
@CreatedUtc datetime,
@CreatedBy uniqueidentifier



	
AS

INSERT INTO 	[dbo].[mp_Tag] 
(
				[Guid],
				VocabularyGuid,
				[SiteGuid],
				[FeatureGuid],
				[ModuleGuid],
				[Tag],
				[CreatedUtc],
				[CreatedBy],
				[ModifiedUtc],
				[ModifiedBy],
				[ItemCount]
) 

VALUES 
(
				@Guid,
				@VocabularyGuid,
				@SiteGuid,
				@FeatureGuid,
				@ModuleGuid,
				@Tag,
				@CreatedUtc,
				@CreatedBy,
				@CreatedUtc,
				@CreatedBy,
				0
				
)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Tag_GetCountByModule]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@ModuleGuid uniqueidentifier

AS

SELECT COUNT(*) FROM [dbo].[mp_Tag]
WHERE
		[ModuleGuid] = @ModuleGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Tag_DeleteBySite]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@SiteGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_Tag]
WHERE
	[SiteGuid] = @SiteGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Tag_DeleteByModule]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@ModuleGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_Tag]
WHERE
	[ModuleGuid] = @ModuleGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Tag_DeleteByFeature]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@FeatureGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_Tag]
WHERE
	[FeatureGuid] = @FeatureGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Tag_Delete]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@Guid uniqueidentifier

AS

DELETE FROM [dbo].[mp_Tag]
WHERE
	[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SiteModuleDefinitions_Update]

/*
Author:   			Joe Audette
Created: 			2010-08-06
Last Modified: 		2010-08-06

*/

@SiteID int,
@ModuleDefID int,
@AuthorizedRoles nvarchar(max)
	
AS

UPDATE mp_SiteModuleDefinitions
SET AuthorizedRoles = @AuthorizedRoles
WHERE SiteID = @SiteID AND ModuleDefID = @ModuleDefID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SiteModuleDefinitions_Insert]

/*
Author:			Joe Audette
Created:		3/12/2005
Last Modified:	2010-08-06

*/


@SiteGuid		uniqueidentifier,
@FeatureGuid	uniqueidentifier



AS

DECLARE @SiteID	int
DECLARE @ModuleDefID int

SET @SiteID = (SELECT TOP 1 SiteID FROM mp_Sites WHERE SiteGuid = @SiteGuid)
SET @ModuleDefID = (SELECT TOP 1 ModuleDefID FROM mp_ModuleDefinitions WHERE Guid = @FeatureGuid)

IF NOT EXISTS (SELECT SiteID FROM mp_SiteModuleDefinitions WHERE SiteID = @SiteID AND ModuleDefID = @ModuleDefID)
INSERT INTO mp_SiteModuleDefinitions (SiteID, ModuleDefID, SiteGuid, FeatureGuid, AuthorizedRoles)

VALUES	(@SiteID, @ModuleDefID, @SiteGuid, @FeatureGuid, 'All Users')
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SiteModuleDefinitions_EnsureForAdminSites]

/*
Author:			Joe Audette
Created:		2007-08-06
Last Modified:	2010-08-06

*/


AS

INSERT INTO mp_SiteModuleDefinitions
(
	SiteID,
	ModuleDefID,
	SiteGuid,
	FeatureGuid,
	AuthorizedRoles
)

SELECT
	s.SiteID,
	md.ModuleDefID,
	s.SiteGuid,
	md.[Guid],
	'All Users'

FROM
	mp_Sites s

CROSS JOIN
	mp_ModuleDefinitions md

WHERE	s.IsServerAdminSite = 1
AND md.Guid NOT IN
(SELECT sd.FeatureGuid FROM mp_SiteModuleDefinitions sd
	WHERE sd.SiteGuid = s.SiteGuid)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SiteModuleDefinitions_DeleteByFeature]


/*
Author:			Joe Audette
Created:		2010-03-17
Last Modified:	2010-03-17

*/


@ModuleDefID	int


AS

DELETE FROM mp_SiteModuleDefinitions
WHERE	
		ModuleDefID = @ModuleDefID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SiteModuleDefinitions_Delete]


/*
Author:			Joe Audette
Created:		3/12/2005
Last Modified:	2008-01-26

*/


@SiteGuid		uniqueidentifier,
@FeatureGuid	uniqueidentifier


AS

DELETE FROM mp_SiteModuleDefinitions
WHERE	SiteGuid = @SiteGuid 
		AND FeatureGuid = @FeatureGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[mp_Pages](
	[PageID] [int] IDENTITY(1,1) NOT NULL,
	[ParentID] [int] NULL,
	[PageOrder] [int] NOT NULL,
	[SiteID] [int] NOT NULL,
	[PageName] [nvarchar](255) NULL,
	[PageTitle] [nvarchar](255) NULL,
	[AuthorizedRoles] [nvarchar](max) NULL,
	[EditRoles] [nvarchar](max) NULL,
	[CreateChildPageRoles] [nvarchar](max) NULL,
	[RequireSSL] [bit] NOT NULL,
	[AllowBrowserCache] [bit] NOT NULL,
	[ShowBreadcrumbs] [bit] NOT NULL,
	[PageKeyWords] [nvarchar](1000) NULL,
	[PageDescription] [nvarchar](255) NULL,
	[PageEncoding] [nvarchar](255) NULL,
	[AdditionalMetaTags] [nvarchar](255) NULL,
	[MenuImage] [nvarchar](50) NULL,
	[UseUrl] [bit] NOT NULL,
	[Url] [nvarchar](255) NULL,
	[OpenInNewWindow] [bit] NOT NULL,
	[ShowChildPageMenu] [bit] NOT NULL,
	[ShowChildBreadCrumbs] [bit] NOT NULL,
	[Skin] [nvarchar](100) NULL,
	[HideMainMenu] [bit] NOT NULL,
	[IncludeInMenu] [bit] NOT NULL,
	[ChangeFrequency] [nvarchar](20) NULL,
	[SiteMapPriority] [nvarchar](10) NULL,
	[LastModifiedUTC] [datetime] NULL,
	[PageGuid] [uniqueidentifier] NOT NULL,
	[ParentGuid] [uniqueidentifier] NOT NULL,
	[HideAfterLogin] [bit] NOT NULL,
	[SiteGuid] [uniqueidentifier] NULL,
	[CompiledMeta] [nvarchar](max) NULL,
	[CompiledMetaUtc] [datetime] NULL,
	[IncludeInSiteMap] [bit] NULL,
	[IsClickable] [bit] NULL,
	[ShowHomeCrumb] [bit] NULL,
	[DraftEditRoles] [nvarchar](max) NULL,
	[IsPending] [bit] NOT NULL,
	[CanonicalOverride] [nvarchar](255) NULL,
	[IncludeInSearchMap] [bit] NULL,
	[EnableComments] [bit] NULL,
	[CreateChildDraftRoles] [nvarchar](max) NULL,
	[IncludeInChildSiteMap] [bit] NULL,
	[PubTeamId] [uniqueidentifier] NULL,
	[BodyCssClass] [nvarchar](50) NULL,
	[MenuCssClass] [nvarchar](50) NULL,
	[ExpandOnSiteMap] [bit] NULL,
	[PublishMode] [int] NULL,
	[PCreatedUtc] [datetime] NOT NULL,
	[PCreatedBy] [uniqueidentifier] NULL,
	[PCreatedFromIp] [nvarchar](36) NULL,
	[PLastModUtc] [datetime] NOT NULL,
	[PLastModBy] [uniqueidentifier] NULL,
	[PLastModFromIp] [nvarchar](36) NULL,
	[MenuDesc] [nvarchar](max) NULL,
	[DraftApprovalRoles] [nvarchar](max) NULL,
	[LinkRel] [nvarchar](20) NULL,
	[PageHeading] [nvarchar](255) NULL,
	[ShowPageHeading] [bit] NOT NULL,
	[PubDateUtc] [datetime] NOT NULL,
 CONSTRAINT [PK_Tabs] PRIMARY KEY CLUSTERED 
(
	[PageID] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF)
)
GO
CREATE NONCLUSTERED INDEX [IX_mp_page_name] ON [dbo].[mp_Pages] 
(
	[PageName] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[mp_Modules](
	[ModuleID] [int] IDENTITY(0,1) NOT NULL,
	[SiteID] [int] NULL,
	[ModuleDefID] [int] NOT NULL,
	[ModuleTitle] [nvarchar](255) NULL,
	[AuthorizedEditRoles] [nvarchar](max) NULL,
	[CacheTime] [int] NOT NULL,
	[ShowTitle] [bit] NULL,
	[EditUserID] [int] NOT NULL,
	[AvailableForMyPage] [bit] NOT NULL,
	[AllowMultipleInstancesOnMyPage] [bit] NOT NULL,
	[Icon] [nvarchar](255) NULL,
	[CreatedByUserID] [int] NULL,
	[CreatedDate] [datetime] NULL,
	[CountOfUseOnMyPage] [int] NOT NULL,
	[Guid] [uniqueidentifier] NULL,
	[FeatureGuid] [uniqueidentifier] NULL,
	[SiteGuid] [uniqueidentifier] NULL,
	[EditUserGuid] [uniqueidentifier] NULL,
	[HideFromUnAuth] [bit] NOT NULL,
	[HideFromAuth] [bit] NOT NULL,
	[ViewRoles] [nvarchar](max) NULL,
	[DraftEditRoles] [nvarchar](max) NULL,
	[IncludeInSearch] [bit] NULL,
	[IsGlobal] [bit] NULL,
	[HeadElement] [nvarchar](25) NULL,
	[PublishMode] [int] NULL,
	[DraftApprovalRoles] [nvarchar](max) NULL,
 CONSTRAINT [PK_Modules] PRIMARY KEY CLUSTERED 
(
	[ModuleID] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF)
)
GO
CREATE NONCLUSTERED INDEX [idxModulesFGuid] ON [dbo].[mp_Modules] 
(
	[FeatureGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [idxModulesGuid] ON [dbo].[mp_Modules] 
(
	[Guid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [idxModulesMDef] ON [dbo].[mp_Modules] 
(
	[ModuleDefID] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [idxModulesSID] ON [dbo].[mp_Modules] 
(
	[SiteID] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ModulesDefId] ON [dbo].[mp_Modules] 
(
	[ModuleDefID] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ModulesFeatGuid] ON [dbo].[mp_Modules] 
(
	[FeatureGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ModulesSiteGuid] ON [dbo].[mp_Modules] 
(
	[SiteGuid] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ModulesSiteId] ON [dbo].[mp_Modules] 
(
	[SiteID] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitionSettings_UpdateByID]

@ID						int,
@ModuleDefID      		int,
@SettingName   		nvarchar(50),
@SettingValue  			nvarchar(max),
@ControlType   			nvarchar(50),
@RegexValidationExpression 	nvarchar(max),
@ResourceFile nvarchar(255),
@ControlSrc	nvarchar(255),
@HelpKey	nvarchar(255),
@SortOrder	int,
@GroupName nvarchar(255)

AS

UPDATE
    mp_ModuleDefinitionSettings

SET
    ResourceFile = @ResourceFile,
	SettingName = @SettingName,
    SettingValue = @SettingValue,
	ControlType = @ControlType,
	RegexValidationExpression = @RegexValidationExpression,
	ControlSrc = @ControlSrc,
	HelpKey = @HelpKey,
	SortOrder = @SortOrder,
	GroupName = @GroupName

WHERE
    ID = @ID AND ModuleDefID = @ModuleDefID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitionSettings_Update]

@ModuleDefID      		int,
@SettingName   		nvarchar(50),
@SettingValue  			nvarchar(max),
@ControlType   			nvarchar(50),
@RegexValidationExpression 	nvarchar(max),
@FeatureGuid uniqueidentifier,
@ResourceFile nvarchar(255),
@ControlSrc	nvarchar(255),
@HelpKey	nvarchar(255),
@SortOrder	int,
@GroupName nvarchar(255)

AS

IF NOT EXISTS (
    SELECT 
        * 
    FROM 
        mp_ModuleDefinitionSettings 
    WHERE 
        (ModuleDefID = @ModuleDefID OR FeatureGuid = @FeatureGuid)
      AND
        SettingName = @SettingName
)
INSERT INTO mp_ModuleDefinitionSettings (
	FeatureGuid,
    ModuleDefID,
	ResourceFile,
    SettingName,
    SettingValue,
	ControlType,
	RegexValidationExpression,
	ControlSrc,
	HelpKey,
	SortOrder,
	GroupName
) 
VALUES (
	@FeatureGuid,
    @ModuleDefID,
	@ResourceFile,
    @SettingName,
    @SettingValue,
	@ControlType,
	@RegexValidationExpression,
	@ControlSrc,
	@HelpKey,
	@SortOrder,
	@GroupName
)
ELSE
UPDATE
    mp_ModuleDefinitionSettings

SET
	FeatureGuid = @FeatureGuid,
    SettingValue = @SettingValue,
	ControlType = @ControlType,
	RegexValidationExpression = @RegexValidationExpression,
	ResourceFile = @ResourceFile,
	ControlSrc = @ControlSrc,
	HelpKey = @HelpKey,
	SortOrder = @SortOrder,
	GroupName = @GroupName

WHERE
    (ModuleDefID = @ModuleDefID OR FeatureGuid = @FeatureGuid)
  AND
    SettingName = @SettingName
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitionSettings_SelectOne]
(
    @FeatureGuid uniqueidentifier,
	@SettingName nvarchar(50)
	
)
AS

SELECT
    *

FROM
    mp_ModuleDefinitionSettings

WHERE
    FeatureGuid = @FeatureGuid
	AND SettingName = @SettingName
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitionSettings_Select]
(
    @ModuleDefID int
)
AS

SELECT
    *

FROM
    mp_ModuleDefinitionSettings

WHERE
    ModuleDefID = @ModuleDefID

ORDER BY SortOrder, GroupName
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitionSettings_DeleteByID]

    
@ID int

AS
DELETE FROM
    mp_ModuleDefinitionSettings

WHERE
    ID = @ID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitionSettings_DeleteByFeature]

    
@ModuleDefID int

AS
DELETE FROM
    mp_ModuleDefinitionSettings

WHERE
    ModuleDefID = @ModuleDefID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentMeta_Update]

/*
Author:   			Joe Audette
Created: 			2009-12-02
Last Modified: 		2010-06-30
*/
	
@Guid uniqueidentifier, 
@Name nvarchar(255), 
@Scheme nvarchar(255), 
@LangCode nvarchar(10), 
@Dir nvarchar(3), 
@MetaContent nvarchar(max), 
@SortRank int, 
@LastModUtc datetime, 
@LastModBy uniqueidentifier 


AS

UPDATE 		[dbo].[mp_ContentMeta] 

SET
			[Name] = @Name,
			[Scheme] = @Scheme,
			[LangCode] = @LangCode,
			[Dir] = @Dir,
			[MetaContent] = @MetaContent,
			[SortRank] = @SortRank,
			[LastModUtc] = @LastModUtc,
			[LastModBy] = @LastModBy
			
WHERE
			[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ContentMeta_SelectOne]

/*
Author:   			Joe Audette
Created: 			2009-12-02
Last Modified: 		2009-12-02
*/

@Guid uniqueidentifier

AS


SELECT	*
		
FROM
		[dbo].[mp_ContentMeta]
		
WHERE
		[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ContentMeta_SelectByContent]

/*
Author:   			Joe Audette
Created: 			2009-12-02
Last Modified: 		2009-12-02
*/

@ContentGuid uniqueidentifier

AS


SELECT	*
		
FROM
		[dbo].[mp_ContentMeta]
		
WHERE
		[ContentGuid] = @ContentGuid
		
ORDER BY
	SortRank
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentMeta_Insert]

/*
Author:   			Joe Audette
Created: 			2009-12-02
Last Modified: 		2010-06-30
*/

@Guid uniqueidentifier,
@SiteGuid uniqueidentifier,
@ModuleGuid uniqueidentifier,
@ContentGuid uniqueidentifier,
@Name nvarchar(255),
@Scheme nvarchar(255),
@LangCode nvarchar(10),
@Dir nvarchar(3),
@MetaContent nvarchar(max),
@SortRank int,
@CreatedUtc datetime,
@CreatedBy uniqueidentifier,
@LastModUtc datetime,
@LastModBy uniqueidentifier

	
AS

INSERT INTO 	[dbo].[mp_ContentMeta] 
(
				[Guid],
				[SiteGuid],
				[ModuleGuid],
				[ContentGuid],
				[Name],
				[Scheme],
				[LangCode],
				[Dir],
				[MetaContent],
				[SortRank],
				[CreatedUtc],
				[CreatedBy],
				[LastModUtc],
				[LastModBy]
) 

VALUES 
(
				@Guid,
				@SiteGuid,
				@ModuleGuid,
				@ContentGuid,
				@Name,
				@Scheme,
				@LangCode,
				@Dir,
				@MetaContent,
				@SortRank,
				@CreatedUtc,
				@CreatedBy,
				@LastModUtc,
				@LastModBy
				
)
GO
 
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ContentMeta_GetMaxSortOrder]

/*
Author:			Joe Audette
Created:		2009-12-02
Last Modified:	2009-12-02

*/

@ContentGuid uniqueidentifier

AS

SELECT	COALESCE(MAX(SortRank), 1)

FROM		mp_ContentMeta

WHERE	ContentGuid = @ContentGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentMeta_DeleteBySite]

/*
Author:   			Joe Audette
Created: 			2009-12-02
Last Modified: 		2009-12-02
*/

@SiteGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_ContentMeta]
WHERE
	[SiteGuid] = @SiteGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentMeta_DeleteByModule]

/*
Author:   			Joe Audette
Created: 			2009-12-02
Last Modified: 		2009-12-02
*/

@ModuleGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_ContentMeta]
WHERE
	[ModuleGuid] = @ModuleGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentMeta_DeleteByContent]

/*
Author:   			Joe Audette
Created: 			2009-12-02
Last Modified: 		2009-12-02
*/

@ContentGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_ContentMeta]
WHERE
	[ContentGuid] = @ContentGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentMeta_Delete]

/*
Author:   			Joe Audette
Created: 			2009-12-02
Last Modified: 		2009-12-02
*/

@Guid uniqueidentifier

AS

DELETE FROM [dbo].[mp_ContentMeta]
WHERE
	[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Comments_Update]

/*
Author:   			Joe Audette
Created: 			2012-8-10
Last Modified: 		2012-8-10
*/
	
@Guid uniqueidentifier, 
@UserGuid uniqueidentifier, 
@Title nvarchar(255), 
@UserComment nvarchar(max), 
@UserName nvarchar(50), 
@UserEmail nvarchar(100), 
@UserUrl nvarchar(255), 
@UserIp nvarchar(50), 
@LastModUtc datetime, 
@ModerationStatus tinyint, 
@ModeratedBy uniqueidentifier, 
@ModerationReason nvarchar(255) 


AS

UPDATE 		[dbo].[mp_Comments] 

SET
			
			[UserGuid] = @UserGuid,
			[Title] = @Title,
			[UserComment] = @UserComment,
			[UserName] = @UserName,
			[UserEmail] = @UserEmail,
			[UserUrl] = @UserUrl,
			[UserIp] = @UserIp,
			[LastModUtc] = @LastModUtc,
			[ModerationStatus] = @ModerationStatus,
			[ModeratedBy] = @ModeratedBy,
			[ModerationReason] = @ModerationReason
			
WHERE
			[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Comments_SelectOne]

/*
Author:   			Joe Audette
Created: 			2012-08-10
Last Modified: 		2012-08-10
*/

@Guid uniqueidentifier

AS


SELECT c.*,
COALESCE(u.[Name], c.UserName) AS PostAuthor,
		COALESCE(u.UserID, -1) AS UserID,
		COALESCE(u.[Email], c.UserEmail) AS AuthorEmail,
		COALESCE(u.TotalRevenue, 0) AS UserRevenue,
		COALESCE(u.Trusted, 0) AS Trusted,
		u.AvatarUrl AS PostAuthorAvatar,
		COALESCE(c.UserUrl, u.WebSiteURL) AS PostAuthorWebSiteUrl
		
		
FROM
		[dbo].[mp_Comments] c
		
LEFT OUTER JOIN		mp_Users u
ON		c.UserGuid = u.UserGuid
		
WHERE
		c.[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Comments_SelectByParentDesc]

/*
Author:   			Joe Audette
Created: 			2012-08-10
Last Modified: 		2012-08-10
*/

@ParentGuid uniqueidentifier

AS


SELECT c.*,
COALESCE(u.[Name], c.UserName) AS PostAuthor,
		COALESCE(u.UserID, -1) AS UserID,
		COALESCE(u.[Email], c.UserEmail) AS AuthorEmail,
		COALESCE(u.TotalRevenue, 0) AS UserRevenue,
		COALESCE(u.Trusted, 0) AS Trusted,
		u.AvatarUrl AS PostAuthorAvatar,
		COALESCE(c.UserUrl, u.WebSiteURL) AS PostAuthorWebSiteUrl
		
FROM
		[dbo].[mp_Comments] c
		
LEFT OUTER JOIN		mp_Users u
ON		c.UserGuid = u.UserGuid
		
WHERE
		c.[ParentGuid] = @ParentGuid
ORDER BY c.CreatedUtc DESC
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Comments_SelectByParentAsc]

/*
Author:   			Joe Audette
Created: 			2012-08-10
Last Modified: 		2012-08-10
*/

@ParentGuid uniqueidentifier

AS


SELECT c.*,
COALESCE(u.[Name], c.UserName) AS PostAuthor,
		COALESCE(u.UserID, -1) AS UserID,
		COALESCE(u.[Email], c.UserEmail) AS AuthorEmail,
		COALESCE(u.TotalRevenue, 0) AS UserRevenue,
		COALESCE(u.Trusted, 0) AS Trusted,
		u.AvatarUrl AS PostAuthorAvatar,
		COALESCE(c.UserUrl, u.WebSiteURL) AS PostAuthorWebSiteUrl
		
FROM
		[dbo].[mp_Comments] c
		
LEFT OUTER JOIN		mp_Users u
ON		c.UserGuid = u.UserGuid
		
WHERE
		c.[ParentGuid] = @ParentGuid
ORDER BY c.CreatedUtc
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Comments_SelectByContentDesc]

/*
Author:   			Joe Audette
Created: 			2012-08-10
Last Modified: 		2012-08-10
*/

@ContentGuid uniqueidentifier

AS


SELECT c.*,
COALESCE(u.[Name], c.UserName) AS PostAuthor,
		COALESCE(u.UserID, -1) AS UserID,
		COALESCE(u.[Email], c.UserEmail) AS AuthorEmail,
		COALESCE(u.TotalRevenue, 0) AS UserRevenue,
		COALESCE(u.Trusted, 0) AS Trusted,
		u.AvatarUrl AS PostAuthorAvatar,
		COALESCE(c.UserUrl, u.WebSiteURL) AS PostAuthorWebSiteUrl
		
FROM
		[dbo].[mp_Comments] c
		
LEFT OUTER JOIN		mp_Users u
ON		c.UserGuid = u.UserGuid
		
WHERE
		c.[ContentGuid] = @ContentGuid
ORDER BY c.CreatedUtc DESC
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Comments_SelectByContentAsc]

/*
Author:   			Joe Audette
Created: 			2012-08-10
Last Modified: 		2012-08-10
*/

@ContentGuid uniqueidentifier

AS


SELECT c.*,
COALESCE(u.[Name], c.UserName) AS PostAuthor,
		COALESCE(u.UserID, -1) AS UserID,
		COALESCE(u.[Email], c.UserEmail) AS AuthorEmail,
		COALESCE(u.TotalRevenue, 0) AS UserRevenue,
		COALESCE(u.Trusted, 0) AS Trusted,
		u.AvatarUrl AS PostAuthorAvatar,
		COALESCE(c.UserUrl, u.WebSiteURL) AS PostAuthorWebSiteUrl
		
FROM
		[dbo].[mp_Comments] c
		
LEFT OUTER JOIN		mp_Users u
ON		c.UserGuid = u.UserGuid
		
WHERE
		c.[ContentGuid] = @ContentGuid
ORDER BY c.CreatedUtc
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Comments_Insert]

/*
Author:   			Joe Audette
Created: 			2012-8-10
Last Modified: 		2012-8-10
*/

@Guid uniqueidentifier,
@SiteGuid uniqueidentifier,
@ParentGuid uniqueidentifier,
@FeatureGuid uniqueidentifier,
@ModuleGuid uniqueidentifier,
@ContentGuid uniqueidentifier,
@UserGuid uniqueidentifier,
@Title nvarchar(255),
@UserComment nvarchar(max),
@UserName nvarchar(50),
@UserEmail nvarchar(100),
@UserUrl nvarchar(255),
@UserIp nvarchar(50),
@CreatedUtc datetime,
@ModerationStatus tinyint,
@ModeratedBy uniqueidentifier,
@ModerationReason nvarchar(255)

	
AS

INSERT INTO 	[dbo].[mp_Comments] 
(
				[Guid],
				[SiteGuid],
				ParentGuid,
				[FeatureGuid],
				[ModuleGuid],
				[ContentGuid],
				[UserGuid],
				[Title],
				[UserComment],
				[UserName],
				[UserEmail],
				[UserUrl],
				[UserIp],
				[CreatedUtc],
				[LastModUtc],
				[ModerationStatus],
				[ModeratedBy],
				[ModerationReason]
) 

VALUES 
(
				@Guid,
				@SiteGuid,
				@ParentGuid,
				@FeatureGuid,
				@ModuleGuid,
				@ContentGuid,
				@UserGuid,
				@Title,
				@UserComment,
				@UserName,
				@UserEmail,
				@UserUrl,
				@UserIp,
				@CreatedUtc,
				@CreatedUtc,
				@ModerationStatus,
				@ModeratedBy,
				@ModerationReason
				
)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Comments_DeleteBySite]

/*
Author:   			Joe Audette
Created: 			2012-08-10
Last Modified: 		2012-08-10
*/

@SiteGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_Comments]
WHERE
	[SiteGuid] = @SiteGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Comments_DeleteByParent]

/*
Author:   			Joe Audette
Created: 			2012-08-10
Last Modified: 		2012-08-10
*/

@ParentGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_Comments]
WHERE
	[ParentGuid] = @ParentGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Comments_DeleteByModule]

/*
Author:   			Joe Audette
Created: 			2012-08-10
Last Modified: 		2012-08-10
*/

@ModuleGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_Comments]
WHERE
	[ModuleGuid] = @ModuleGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Comments_DeleteByFeature]

/*
Author:   			Joe Audette
Created: 			2012-08-10
Last Modified: 		2012-08-10
*/

@FeatureGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_Comments]
WHERE
	[FeatureGuid] = @FeatureGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Comments_DeleteByContent]

/*
Author:   			Joe Audette
Created: 			2012-08-10
Last Modified: 		2012-08-10
*/

@ContentGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_Comments]
WHERE
	[ContentGuid] = @ContentGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Comments_Delete]

/*
Author:   			Joe Audette
Created: 			2012-08-10
Last Modified: 		2012-08-10
*/

@Guid uniqueidentifier

AS

DELETE FROM [dbo].[mp_Comments]
WHERE
	[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Comments_CountBySite]

/*
Author:   			Joe Audette
Created: 			2012-08-20
Last Modified: 		2012-08-20
*/

@SiteGuid uniqueidentifier

AS

SELECT COUNT(*) 
FROM [dbo].[mp_Comments]
WHERE
@SiteGuid = '00000000-0000-0000-0000-000000000000' OR   SiteGuid = @SiteGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Comments_CountByModule]

/*
Author:   			Joe Audette
Created: 			2012-08-20
Last Modified: 		2012-08-20
*/

@ModuleGuid uniqueidentifier,
@ModerationStatus tinyint

AS

SELECT COUNT(*) 
FROM [dbo].[mp_Comments]
WHERE
ModuleGuid = @ModuleGuid
AND
ModerationStatus = @ModerationStatus
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Comments_CountByContent]

/*
Author:   			Joe Audette
Created: 			2012-8-10
Last Modified: 		2012-8-10
*/

@ContentGuid uniqueidentifier,
@ModerationStatus tinyint

AS

SELECT COUNT(*) 
FROM [dbo].[mp_Comments]
WHERE
ContentGuid = @ContentGuid
AND
ModerationStatus = @ModerationStatus
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_CategoryItem_Insert]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@Guid uniqueidentifier,
@SiteGuid uniqueidentifier,
@FeatureGuid uniqueidentifier,
@ModuleGuid uniqueidentifier,
@ItemGuid uniqueidentifier,
@CategoryGuid uniqueidentifier,
@ExtraGuid uniqueidentifier

	
AS

INSERT INTO 	[dbo].[mp_CategoryItem] 
(
				[Guid],
				[SiteGuid],
				[FeatureGuid],
				[ModuleGuid],
				[ItemGuid],
				[CategoryGuid],
				[ExtraGuid]
) 

VALUES 
(
				@Guid,
				@SiteGuid,
				@FeatureGuid,
				@ModuleGuid,
				@ItemGuid,
				@CategoryGuid,
				@ExtraGuid
				
)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_CategoryItem_DeleteBySite]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@SiteGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_CategoryItem]
WHERE
	[SiteGuid] = @SiteGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_CategoryItem_DeleteByModule]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@ModuleGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_CategoryItem]
WHERE
	[ModuleGuid] = @ModuleGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_CategoryItem_DeleteByItem]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@ItemGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_CategoryItem]
WHERE
	[ItemGuid] = @ItemGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_CategoryItem_DeleteByFeature]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@FeatureGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_CategoryItem]
WHERE
	[FeatureGuid] = @FeatureGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_CategoryItem_DeleteByExtraGuid]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@ExtraGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_CategoryItem]
WHERE
	[ExtraGuid] = @ExtraGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_CategoryItem_DeleteByCategory]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@CategoryGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_CategoryItem]
WHERE
	[CategoryGuid] = @CategoryGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_CategoryItem_Delete]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@Guid uniqueidentifier

AS

DELETE FROM [dbo].[mp_CategoryItem]
WHERE
	[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Category_UpdateItemCount]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/
	
@Guid uniqueidentifier


AS

UPDATE 		[dbo].[mp_Category] 

SET
			ItemCount = (SELECT Count(*) FROM [dbo].mp_CategoryItem WHERE CategoryGuid = @Guid)
			
WHERE
			[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Category_Update]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/
	
@Guid uniqueidentifier, 
@ParentGuid uniqueidentifier, 
@Category nvarchar(255), 
@Description nvarchar(max), 
@ModifiedUtc datetime, 
@ModifiedBy uniqueidentifier 


AS

UPDATE 		[dbo].[mp_Category] 

SET
			[ParentGuid] = @ParentGuid,
			[Category] = @Category,
			[Description] = @Description,
			[ModifiedUtc] = @ModifiedUtc,
			[ModifiedBy] = @ModifiedBy
			
WHERE
			[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Category_SelectOne]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@Guid uniqueidentifier

AS


SELECT	*
		
FROM
		[dbo].[mp_Category]
		
WHERE
		[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Category_SelectByModule]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@ModuleGuid uniqueidentifier

AS


SELECT	*
		
FROM
		[dbo].[mp_Category]
		
WHERE
		[ModuleGuid] = @ModuleGuid
ORDER BY Category
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Category_Insert]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@Guid uniqueidentifier,
@ParentGuid uniqueidentifier,
@SiteGuid uniqueidentifier,
@FeatureGuid uniqueidentifier,
@ModuleGuid uniqueidentifier,
@Category nvarchar(255),
@Description nvarchar(max),
@CreatedUtc datetime,
@CreatedBy uniqueidentifier

	
AS

INSERT INTO 	[dbo].[mp_Category] 
(
				[Guid],
				[ParentGuid],
				[SiteGuid],
				[FeatureGuid],
				[ModuleGuid],
				[Category],
				[Description],
				[ItemCount],
				[CreatedUtc],
				[CreatedBy],
				[ModifiedUtc],
				[ModifiedBy]
) 

VALUES 
(
				@Guid,
				@ParentGuid,
				@SiteGuid,
				@FeatureGuid,
				@ModuleGuid,
				@Category,
				@Description,
				0,
				@CreatedUtc,
				@CreatedBy,
				@CreatedUtc,
				@CreatedBy
				
)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Category_GetCountByModule]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/
@ModuleGuid uniqueidentifier

AS

SELECT COUNT(*) FROM [dbo].[mp_Category]
WHERE
		[ModuleGuid] = @ModuleGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Category_DeleteBySite]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@SiteGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_Category]
WHERE
	[SiteGuid] = @SiteGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Category_DeleteByModule]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@ModuleGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_Category]
WHERE
	[ModuleGuid] = @ModuleGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Category_DeleteByFeature]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@FeatureGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_Category]
WHERE
	[FeatureGuid] = @FeatureGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Category_Delete]

/*
Author:   			Joe Audette
Created: 			2011-10-31
Last Modified: 		2011-10-31
*/

@Guid uniqueidentifier

AS

DELETE FROM [dbo].[mp_Category]
WHERE
	[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentRating_Update]

/*
Author:   			Joe Audette
Created: 			2008-10-06
Last Modified: 		2010-06-30
*/
	
@RowGuid uniqueidentifier, 
@EmailAddress nvarchar(100), 
@Rating int, 
@Comments nvarchar(max), 
@IpAddress nvarchar(50), 
@LastModUtc datetime 


AS

UPDATE 		[dbo].[mp_ContentRating] 

SET
			
			[EmailAddress] = @EmailAddress,
			[Rating] = @Rating,
			[Comments] = @Comments,
			[IpAddress] = @IpAddress,
			[LastModUtc] = @LastModUtc
			
WHERE
			[RowGuid] = @RowGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentRating_SelectPageByContent]

-- Author:   			Joe Audette
-- Created: 			2008-10-06
-- Last Modified: 		2008-10-06

@ContentGuid uniqueidentifier,
@PageNumber 			int,
@PageSize 			int

AS

DECLARE @PageLowerBound int
DECLARE @PageUpperBound int


SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1



CREATE TABLE #PageIndex 
(
	[IndexID] int IDENTITY (1, 1) NOT NULL,
	[ItemGuid] UniqueIdentifier
)

BEGIN

INSERT INTO #PageIndex ([ItemGuid])

SELECT
		[RowGuid]
		
FROM
		[dbo].[mp_ContentRating]
		
WHERE
		[ContentGuid] = @ContentGuid

ORDER BY CreatedUtc DESC

END


SELECT
		t1.*
		
FROM
		[dbo].[mp_ContentRating] t1

JOIN			#PageIndex t2
ON			
		t1.[RowGuid] = t2.[ItemGuid]
		
WHERE
		t2.IndexID > @PageLowerBound 
		AND t2.IndexID < @PageUpperBound
		
ORDER BY t2.IndexID

DROP TABLE #PageIndex
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentRating_SelectOneByContentAndUser]

/*
Author:   			Joe Audette
Created: 			2008-10-06
Last Modified: 		2008-10-06
*/

@ContentGuid uniqueidentifier,
@UserGuid uniqueidentifier

AS


SELECT *
		
FROM
		[dbo].[mp_ContentRating]
		
WHERE
		[ContentGuid] = @ContentGuid
		AND [UserGuid] = @UserGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentRating_SelectOne]

/*
Author:   			Joe Audette
Created: 			2008-10-06
Last Modified: 		2008-10-06
*/

@RowGuid uniqueidentifier

AS


SELECT *
		
FROM
		[dbo].[mp_ContentRating]
		
WHERE
		[RowGuid] = @RowGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentRating_Insert]

/*
Author:   			Joe Audette
Created: 			2008-10-06
Last Modified: 		2010-06-30
*/

@RowGuid uniqueidentifier,
@SiteGuid uniqueidentifier,
@ContentGuid uniqueidentifier,
@UserGuid uniqueidentifier,
@EmailAddress nvarchar(100),
@Rating int,
@Comments nvarchar(max),
@IpAddress nvarchar(50),
@CreatedUtc datetime,
@LastModUtc datetime

	
AS

INSERT INTO 	[dbo].[mp_ContentRating] 
(
				[RowGuid],
				[SiteGuid],
				[ContentGuid],
				[UserGuid],
				[EmailAddress],
				[Rating],
				[Comments],
				[IpAddress],
				[CreatedUtc],
				[LastModUtc]
) 

VALUES 
(
				@RowGuid,
				@SiteGuid,
				@ContentGuid,
				@UserGuid,
				@EmailAddress,
				@Rating,
				@Comments,
				@IpAddress,
				@CreatedUtc,
				@LastModUtc
				
)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentRating_GetStatsByContent]

/*
Author:   			Joe Audette
Created: 			2008-10-06
Last Modified: 		2013-05-31
*/

@ContentGuid uniqueidentifier

AS

SELECT 
-- COALESCE(AVG(Rating),0) As CurrentRating,
COALESCE(CONVERT(int,ROUND(AVG(CONVERT(decimal,Rating)),0)),0) As CurrentRating,
Count(*) As TotalRatings

FROM [dbo].[mp_ContentRating]

WHERE [ContentGuid] = @ContentGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentRating_GetCountByContentAndUser]

/*
Author:   			Joe Audette
Created: 			2008-10-06
Last Modified: 		2008-10-06
*/

@ContentGuid uniqueidentifier,
@UserGuid uniqueidentifier

AS

SELECT COUNT(*) 
FROM [dbo].[mp_ContentRating]
WHERE [ContentGuid] = @ContentGuid
		AND [UserGuid] = @UserGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentRating_GetCountByContentAndIPAddress]

/*
Author:   			Joe Audette
Created: 			2008-10-07
Last Modified: 		2008-10-07
*/

@ContentGuid uniqueidentifier,
@IpAddress nvarchar(50),
@BeginUtc datetime

AS

SELECT COUNT(*) 
FROM [dbo].[mp_ContentRating]
WHERE [ContentGuid] = @ContentGuid
		AND [UserGuid] = '00000000-0000-0000-0000-000000000000'
		AND [IpAddress] = @IpAddress
		AND CreatedUtc > @BeginUtc
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentRating_GetCountByContent]

/*
Author:   			Joe Audette
Created: 			2008-10-06
Last Modified: 		2008-10-06
*/

@ContentGuid uniqueidentifier

AS

SELECT COUNT(*) 
FROM [dbo].[mp_ContentRating]
WHERE [ContentGuid] = @ContentGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentRating_DeleteByUser]

/*
Author:   			Joe Audette
Created: 			2008-10-06
Last Modified: 		2008-10-06
*/

@UserGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_ContentRating]
WHERE
	[UserGuid] = @UserGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentRating_DeleteBySite]

/*
Author:   			Joe Audette
Created: 			2008-10-06
Last Modified: 		2008-10-06
*/

@SiteGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_ContentRating]
WHERE
	[SiteGuid] = @SiteGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentRating_DeleteByContent]

/*
Author:   			Joe Audette
Created: 			2008-10-06
Last Modified: 		2008-10-06
*/

@ContentGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_ContentRating]
WHERE
	[ContentGuid] = @ContentGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentRating_Delete]

/*
Author:   			Joe Audette
Created: 			2008-10-06
Last Modified: 		2008-10-06
*/

@RowGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_ContentRating]
WHERE
	[RowGuid] = @RowGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentMetaLink_Update]

/*
Author:   			Joe Audette
Created: 			2009-12-05
Last Modified: 		2009-12-05
*/
	
@Guid uniqueidentifier, 
@Rel nvarchar(255), 
@Href nvarchar(255), 
@HrefLang nvarchar(10), 
@Rev nvarchar(50), 
@Type nvarchar(50), 
@Media nvarchar(50), 
@SortRank int, 
@LastModUtc datetime, 
@LastModBy uniqueidentifier 


AS

UPDATE 		[dbo].[mp_ContentMetaLink] 

SET
			[Rel] = @Rel,
			[Href] = @Href,
			[HrefLang] = @HrefLang,
			[Rev] = @Rev,
			[Type] = @Type,
			[Media] = @Media,
			[SortRank] = @SortRank,
			[LastModUtc] = @LastModUtc,
			[LastModBy] = @LastModBy
			
WHERE
			[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentMetaLink_SelectOne]

/*
Author:   			Joe Audette
Created: 			2009-12-05
Last Modified: 		2009-12-05
*/

@Guid uniqueidentifier

AS


SELECT *
		
FROM
		[dbo].[mp_ContentMetaLink]
		
WHERE
		[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentMetaLink_SelectByContent]

/*
Author:   			Joe Audette
Created: 			2009-12-05
Last Modified: 		2009-12-05
*/

@ContentGuid uniqueidentifier

AS


SELECT *
		
FROM
		[dbo].[mp_ContentMetaLink]
		
WHERE
		[ContentGuid] = @ContentGuid
		
ORDER BY
		SortRank
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentMetaLink_Insert]

/*
Author:   			Joe Audette
Created: 			2009-12-5
Last Modified: 		2009-12-5
*/

@Guid uniqueidentifier,
@SiteGuid uniqueidentifier,
@ModuleGuid uniqueidentifier,
@ContentGuid uniqueidentifier,
@Rel nvarchar(255),
@Href nvarchar(255),
@HrefLang nvarchar(10),
@Rev nvarchar(50),
@Type nvarchar(50),
@Media nvarchar(50),
@SortRank int,
@CreatedUtc datetime,
@CreatedBy uniqueidentifier,
@LastModUtc datetime,
@LastModBy uniqueidentifier

	
AS

INSERT INTO 	[dbo].[mp_ContentMetaLink] 
(
				[Guid],
				[SiteGuid],
				[ModuleGuid],
				[ContentGuid],
				[Rel],
				[Href],
				[HrefLang],
				[Rev],
				[Type],
				[Media],
				[SortRank],
				[CreatedUtc],
				[CreatedBy],
				[LastModUtc],
				[LastModBy]
) 

VALUES 
(
				@Guid,
				@SiteGuid,
				@ModuleGuid,
				@ContentGuid,
				@Rel,
				@Href,
				@HrefLang,
				@Rev,
				@Type,
				@Media,
				@SortRank,
				@CreatedUtc,
				@CreatedBy,
				@LastModUtc,
				@LastModBy
				
)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentMetaLink_GetMaxSortOrder]

/*
Author:			Joe Audette
Created:		2009-12-05
Last Modified:	2009-12-05

*/

@ContentGuid uniqueidentifier

AS

SELECT	COALESCE(MAX(SortRank), 1)

FROM		mp_ContentMetaLink

WHERE	ContentGuid = @ContentGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentMetaLink_DeleteBySite]

/*
Author:   			Joe Audette
Created: 			2009-12-05
Last Modified: 		2009-12-05
*/

@SiteGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_ContentMetaLink]
WHERE
	[SiteGuid] = @SiteGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentMetaLink_DeleteByModule]

/*
Author:   			Joe Audette
Created: 			2009-12-05
Last Modified: 		2009-12-05
*/

@ModuleGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_ContentMetaLink]
WHERE
	[ModuleGuid] = @ModuleGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentMetaLink_DeleteByContent]

/*
Author:   			Joe Audette
Created: 			2009-12-05
Last Modified: 		2009-12-05
*/

@ContentGuid uniqueidentifier

AS

DELETE FROM [dbo].[mp_ContentMetaLink]
WHERE
	[ContentGuid] = @ContentGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ContentMetaLink_Delete]

/*
Author:   			Joe Audette
Created: 			2009-12-05
Last Modified: 		2009-12-05
*/

@Guid uniqueidentifier

AS

DELETE FROM [dbo].[mp_ContentMetaLink]
WHERE
	[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitions_Update]

/*
Author:   			Joe Audette
Created: 			2004-12-26
Last Modified: 		2014-07-29

*/
	
@ModuleDefID int, 
@FeatureName nvarchar(255), 
@ControlSrc nvarchar(255), 
@SortOrder int, 
@IsAdmin bit,
@Icon	nvarchar(255),
@DefaultCacheTime int,
@ResourceFile nvarchar(255),
@IsCacheable bit,
@IsSearchable bit,
@SearchListName nvarchar(255),
@SupportsPageReuse	bit,
@DeleteProvider nvarchar(255),
@PartialView nvarchar(255)


AS
UPDATE 		[dbo].[mp_ModuleDefinitions] 

SET

			[FeatureName] = @FeatureName,
			[ControlSrc] = @ControlSrc,
			[SortOrder] = @SortOrder,
			DefaultCacheTime = @DefaultCacheTime,
			Icon = @Icon,
			[IsAdmin] = @IsAdmin,
			[ResourceFile] = @ResourceFile,
			IsCacheable = @IsCacheable,
			IsSearchable = @IsSearchable,
			SearchListName = @SearchListName,
			SupportsPageReuse = @SupportsPageReuse,
			DeleteProvider = @DeleteProvider,
			PartialView = @PartialView
			
WHERE
			[ModuleDefID] = @ModuleDefID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitions_SelectUserModules]

    
@SiteID  int


AS

SELECT   		md.*,
smd.AuthorizedRoles

FROM			mp_ModuleDefinitions md

JOIN			mp_SiteModuleDefinitions smd
ON			smd.ModuleDefID = md.ModuleDefID
    
WHERE   		smd.SiteID = @SiteID
			AND md.IsAdmin = 0

ORDER BY 		md.SortOrder, md.FeatureName
GO
 
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitions_SelectSearchableModules]

    
@SiteID  int


AS

SELECT   		md.*

FROM			mp_ModuleDefinitions md

JOIN			mp_SiteModuleDefinitions smd
ON			smd.ModuleDefID = md.ModuleDefID
    
WHERE   		smd.SiteID = @SiteID
			AND md.IsAdmin = 0
			AND md.IsSearchable = 1

ORDER BY 		md.SortOrder, md.SearchListName
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitions_SelectOneByGuid]

    
@FeatureGuid uniqueidentifier

AS

SELECT	*

FROM
    mp_ModuleDefinitions

WHERE
    [Guid] = @FeatureGuid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitions_SelectOne]

    
@ModuleDefID int

AS

SELECT	*

FROM
    mp_ModuleDefinitions

WHERE
    ModuleDefID = @ModuleDefID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitions_Select]

    
@SiteGuid  uniqueidentifier


AS

SELECT   	md.*,
smd.AuthorizedRoles

FROM		mp_ModuleDefinitions md

JOIN		mp_SiteModuleDefinitions smd
ON		smd.FeatureGuid = md.[Guid]
    
WHERE   	smd.SiteGuid = @SiteGuid

ORDER BY 	md.SortOrder, md.FeatureName
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitions_Insert]

/*
Author:   			Joe Audette
Created: 			2004-12-26
Last Modified: 		2014-07-29

*/

@SiteID int,
@FeatureName nvarchar(255),
@ControlSrc nvarchar(255),
@SortOrder int,
@IsAdmin bit,
@Icon	nvarchar(255),
@DefaultCacheTime int,
@FeatureGuid uniqueidentifier,
@ResourceFile nvarchar(255),
@IsCacheable bit,
@IsSearchable bit,
@SearchListName nvarchar(255),
@SupportsPageReuse	bit,
@DeleteProvider nvarchar(255),
@PartialView nvarchar(255)
	
AS
DECLARE @ModuleDefID int

INSERT INTO 	[dbo].[mp_ModuleDefinitions] 
(
				[Guid],
				[FeatureName],
				[ControlSrc],
				[SortOrder],
				DefaultCacheTime,
				Icon,
				[IsAdmin],
				[ResourceFile],
				IsCacheable,
				IsSearchable,
				SearchListName,
				SupportsPageReuse,
				DeleteProvider,
				PartialView
) 

VALUES 
(
				@FeatureGuid,
				@FeatureName,
				@ControlSrc,
				@SortOrder,
				@DefaultCacheTime,
				@Icon,
				@IsAdmin,
				@ResourceFile,
				@IsCacheable,
				@IsSearchable,
				@SearchListName,
				@SupportsPageReuse,
				@DeleteProvider,
				@PartialView
				
)


SET @ModuleDefID =  @@IDENTITY 

IF @SiteID > -1
BEGIN
DECLARE @SiteGuid uniqueidentifier
SET @SiteGuid = (SELECT TOP 1 SiteGuid FROM mp_Sites WHERE SiteID = @SiteID)
Exec mp_SiteModuleDefinitions_Insert @SiteGuid, @FeatureGuid

END

SELECT @ModuleDefID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_CountByFeatureBySite]

/*
Author:   			Joe Audette
Created: 			2011-09-20
Last Modified: 		2011-09-20
*/


@ModuleDefID	int

AS

SELECT 

s.SiteID,
s.SiteName,
COUNT(m.ModuleID) 

FROM [dbo].[mp_Modules] m

JOIN mp_Sites s
ON m.SiteID = s.SiteID


WHERE 	m.ModuleDefID = @ModuleDefID

GROUP BY s.SiteID, s.SiteName
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_CountByFeature]

/*
Author:   			Joe Audette
Created: 			2011-09-20
Last Modified: 		2011-09-20
*/


@ModuleDefID	int

AS

SELECT COUNT(*) 
FROM [dbo].[mp_Modules] 


WHERE 			ModuleDefID = @ModuleDefID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_GetCount]

/*
Author:   			Joe Audette
Created: 			2009-06-15
Last Modified: 		2009-06-15
*/

@SiteID			int,
@ModuleDefID	int,
@Title nvarchar(255)

AS

SELECT COUNT(*) 
FROM [dbo].[mp_Modules] m
JOIN			[dbo].mp_ModuleDefinitions md
ON				md.ModuleDefID = m.ModuleDefID

WHERE 			m.SiteID = @SiteID
				AND ((m.ModuleDefID = @ModuleDefID) OR (@ModuleDefID = -1))
				AND ((m.ModuleTitle LIKE '%' + @Title + '%') OR (@Title = ''))
				AND md.IsAdmin = 0
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_SelectOneByGuid]

/*
Author:   			Joe Audette
Created: 			2009-02-11
Last Modified: 		2011-03-08

*/

@Guid uniqueidentifier

AS


SELECT	m.*,
		md.ControlSrc,
		md.FeatureName
		
FROM
		[dbo].[mp_Modules] m
		
JOIN
    			mp_ModuleDefinitions md
ON 			m.ModuleDefID = md.ModuleDefID
		
WHERE
		m.[Guid] = @Guid
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_SelectOne]

/*
Author:   			Joe Audette
Created: 			2004-12-26
Last Modified: 		2011-03-08

*/

@ModuleID int

AS


SELECT	m.*,
		md.ControlSrc,
		md.FeatureName
		
FROM
		[dbo].[mp_Modules] m
		
JOIN
    			mp_ModuleDefinitions md
ON 			m.ModuleDefID = md.ModuleDefID
		
WHERE
		m.[ModuleID] = @ModuleID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[mp_PageModules](
	[PageID] [int] NOT NULL,
	[ModuleID] [int] NOT NULL,
	[PaneName] [nvarchar](50) NOT NULL,
	[ModuleOrder] [int] NOT NULL,
	[PublishBeginDate] [datetime] NOT NULL,
	[PublishEndDate] [datetime] NULL,
	[PageGuid] [uniqueidentifier] NULL,
	[ModuleGuid] [uniqueidentifier] NULL,
 CONSTRAINT [PK_mp_PageModules] PRIMARY KEY CLUSTERED 
(
	[PageID] ASC,
	[ModuleID] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF)
)
GO
CREATE NONCLUSTERED INDEX [IX_mp_pm_pane] ON [dbo].[mp_PageModules] 
(
	[PaneName] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
 
SET QUOTED_IDENTIFIER OFF
GO
CREATE Procedure [dbo].[mp_Pages_SelectPendingPageCount]

/*
Author:   			Kevin Needham
Created: 			2009-06-19
Last Modified: 		2009-07-20
*/

@SiteGuid uniqueidentifier

As

Select	Count(*)
From	[dbo].mp_Pages
Where	
	SiteGuid = @SiteGuid
	AND IsPending = 1
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_SelectPage]

-- Author:   			Joe Audette
-- Created: 			2011-02-06
-- Last Modified: 		2011-02-06

@SiteID			int,
@IncludePending bit,
@PageNumber int,
@PageSize int

AS

DECLARE @PageLowerBound int
DECLARE @PageUpperBound int

SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1

CREATE TABLE #PageIndex 
(
	IndexID int IDENTITY (1, 1) NOT NULL,
PageID Int
)

BEGIN

INSERT INTO #PageIndex ( 
PageID
)

SELECT
		[PageID]
		
FROM
		[dbo].[mp_Pages]
		
WHERE
		SiteID = @SiteID
		AND ((IsPending = 0) OR (@IncludePending = 1))

ORDER BY
		ParentID,  PageName

END


SELECT
		t1.*
		
FROM
		[dbo].[mp_Pages] t1

JOIN			#PageIndex t2
ON			
		t1.[PageID] = t2.[PageID]
		
WHERE
		t2.IndexID > @PageLowerBound 
		AND t2.IndexID < @PageUpperBound
		
ORDER BY t2.IndexID

DROP TABLE #PageIndex
GO
 
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Pages_SelectOneByGuid]

/*
Author:				Joe Audette
Created:			2007-08-07
Last Modified:		2012-10-08

*/

@PageGuid uniqueidentifier


AS
SELECT TOP 1	p.*,
u1.[Name] As CreatedByName,
u1.Email As CreatedByEmail,
u1.FirstName As CreatedByFirstName,
u1.LastName As CreatedByLastName,
u2.[Name] As LastModByName,
u2.Email As LastModByEmail,
u2.FirstName As LastModByFirstName,
u2.LastName As LastModByLastName

FROM		mp_Pages p

LEFT OUTER JOIN		mp_Users u1
ON	p.PCreatedBy = u1.UserGuid

LEFT OUTER JOIN		mp_Users u2
ON	p.PLastModBy = u2.UserGuid

WHERE	p.PageGuid = @PageGuid
GO
 
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Pages_SelectOne]

/*
Author:				Joe Audette
Created:			2004-11-07
Last Modified:		2012-10-08

*/

@SiteID		int,
@PageID		int


AS
SELECT TOP 1	p.*,
u1.[Name] As CreatedByName,
u1.Email As CreatedByEmail,
u1.FirstName As CreatedByFirstName,
u1.LastName As CreatedByLastName,
u2.[Name] As LastModByName,
u2.Email As LastModByEmail,
u2.FirstName As LastModByFirstName,
u2.LastName As LastModByLastName

FROM		mp_Pages p

LEFT OUTER JOIN		mp_Users u1
ON	p.PCreatedBy = u1.UserGuid

LEFT OUTER JOIN		mp_Users u2
ON	p.PLastModBy = u2.UserGuid

WHERE	(p.PageID = @PageID OR @PageID = -1)
		AND p.SiteID = @SiteID 
		
ORDER BY p.ParentID, p.PageOrder
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_SelectList]

/*
Author:				Joe Audette
Created:			7/27/2004
Last Modified:			7/27/2004

*/

@SiteID			int



AS

SELECT  			*
    				
    
FROM    
    				mp_Pages
    
WHERE   
    				SiteID = @SiteID

ORDER BY			ParentID,  PageName
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_SelectChildPagesAlpha]

/*
Author:				Joe Audette
Created:			2011-11-24
Last Modified:		2011-11-24

pass in -1 for ParentID to get root level pages
pass in -2 for ParentID to get All pages in the site

*/

@SiteID			int,
@ParentID int



AS

SELECT  			*
    				
    
FROM    
    				[dbo].mp_Pages
    
WHERE   
    				SiteID = @SiteID
    				AND (ParentID = @ParentID OR @ParentID = -2)

ORDER BY			PageName
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_SelectChildPages]

/*
Author:				Joe Audette
Created:			2005-02-20
Last Modified:		2010-02-10

*/

@SiteID int,
@ParentID		int


AS


SELECT	*

FROM		mp_Pages

WHERE	ParentID = @ParentID
		AND SiteID = @SiteID

ORDER BY PageOrder
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_Insert]

/*
Author:			Joe Audette
Created:		2004-11-17
Last Modified:	2013-12-13

*/

@SiteID   		int,
@ParentID		int,
@PageName    		nvarchar(255),
@PageOrder   		int,
@AuthorizedRoles 	nvarchar(max),
@EditRoles		nvarchar(max),
@DraftEditRoles nvarchar(max),
@DraftApprovalRoles nvarchar(max),
@CreateChildPageRoles nvarchar(max),
@CreateChildDraftRoles nvarchar(max),
@RequireSSL		bit,
@ShowBreadcrumbs 	bit,
@ShowChildPageBreadcrumbs 	bit,
@PageKeyWords	nvarchar(1000),
@PageDescription	nvarchar(255),
@PageEncoding	nvarchar(255),
@AdditionalMetaTags	nvarchar(255),
@UseUrl		bit,
@Url			nvarchar(255),
@OpenInNewWindow	bit,
@ShowChildPageMenu	bit,
@HideMainMenu	bit,
@Skin			nvarchar(100),
@IncludeInMenu	bit,
@MenuImage			nvarchar(50),
@PageTitle    		nvarchar(255),
@AllowBrowserCache	bit,
@ChangeFrequency	nvarchar(20),
@SiteMapPriority			nvarchar(10),
@LastModifiedUTC			datetime,
@PageGuid	uniqueidentifier,
@ParentGuid uniqueidentifier,
@HideAfterLogin	bit,
@SiteGuid	uniqueidentifier,
@CompiledMeta		nvarchar(max),
@CompiledMetaUtc	datetime,
@IncludeInSiteMap bit,
@IsClickable bit,
@ShowHomeCrumb bit,
@IsPending bit,
@CanonicalOverride nvarchar(255),
@IncludeInSearchMap bit,
@EnableComments bit,
@IncludeInChildSiteMap bit,
@ExpandOnSiteMap bit,
@PubTeamId uniqueidentifier,
@BodyCssClass nvarchar(50),
@MenuCssClass nvarchar(50),
@PublishMode int,
@PCreatedUtc DateTime,
@PCreatedBy uniqueidentifier,
@PCreatedFromIp nvarchar(36),
@PLastModUtc DateTime,
@PLastModBy uniqueidentifier,
@PLastModFromIp nvarchar(36),
@MenuDesc nvarchar(max),
@LinkRel nvarchar(20),
@PageHeading nvarchar(255),
@ShowPageHeading bit,
@PubDateUtc DateTime

AS
INSERT INTO 		[dbo].mp_Pages
(
    			SiteID,
			ParentID,
    			PageName,
				PageTitle,
    			PageOrder,
			AuthorizedRoles,
			EditRoles,
			DraftEditRoles,
			DraftApprovalRoles,
			CreateChildPageRoles,
			CreateChildDraftRoles,
    			RequireSSL,
			AllowBrowserCache,
    			ShowBreadcrumbs,
			ShowChildBreadCrumbs,
    			PageKeyWords,
			PageDescription,
			PageEncoding,
			AdditionalMetaTags,
			UseUrl,
			Url,
			OpenInNewWindow,
			ShowChildPageMenu,
			HideMainMenu,
			Skin,
			IncludeInMenu,
			MenuImage,
			ChangeFrequency,
			SiteMapPriority,
			LastModifiedUTC,
			PageGuid,
			ParentGuid,
			HideAfterLogin,
			SiteGuid,
			CompiledMeta,
			CompiledMetaUtc,
			IncludeInSiteMap,
			IsClickable,
			ShowHomeCrumb,
			IsPending,
			CanonicalOverride,
			IncludeInSearchMap,
			EnableComments,
			IncludeInChildSiteMap,
			PubTeamId,
			BodyCssClass,
			MenuCssClass,
			ExpandOnSiteMap,
			PublishMode,
			PCreatedUtc,
			PCreatedBy,
			PCreatedFromIp,
			PLastModUtc,
			PLastModBy,
			PLastModFromIp,
			MenuDesc,
			LinkRel,
			PageHeading,
			ShowPageHeading,
			PubDateUtc
)

VALUES
(
    			@SiteID,
			@ParentID,
    			@PageName,
				@PageTitle,
    			@PageOrder,
			@AuthorizedRoles,
			@EditRoles,
			@DraftEditRoles,
			@DraftApprovalRoles,
			@CreateChildPageRoles,
			@CreateChildDraftRoles,
    			@RequireSSL,
			@AllowBrowserCache,
    			@ShowBreadcrumbs,
			@ShowChildPageBreadcrumbs,
			@PageKeyWords,
			@PageDescription,
			@PageEncoding,
			@AdditionalMetaTags,
			@UseUrl,
			@Url,
			@OpenInNewWindow,
			@ShowChildPageMenu,
			@HideMainMenu,
			@Skin,
			@IncludeInMenu,
			@MenuImage,
			@ChangeFrequency,
			@SiteMapPriority,
			@LastModifiedUTC,
			@PageGuid,
			@ParentGuid,
			@HideAfterLogin,
			@SiteGuid,
			@CompiledMeta,
			@CompiledMetaUtc,
			@IncludeInSiteMap,
			@IsClickable,
			@ShowHomeCrumb,
			@IsPending,
			@CanonicalOverride,
			@IncludeInSearchMap,
			@EnableComments,
			@IncludeInChildSiteMap,
			@PubTeamId,
			@BodyCssClass,
			@MenuCssClass,
			@ExpandOnSiteMap,
			@PublishMode,
			@PCreatedUtc,
			@PCreatedBy,
			@PCreatedFromIp,
			@PLastModUtc,
			@PLastModBy,
			@PLastModFromIp,
			@MenuDesc,
			@LinkRel,
			@PageHeading,
			@ShowPageHeading,
			@PubDateUtc
)

SELECT  @@Identity As PageID
GO
 
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Pages_GetNextPageOrder]

/*
Author:			Joe Audette
Created:		11/7/2004
Last Modified:	04/29/2007

*/

@SiteID int,
@ParentID		int

AS

SELECT	COALESCE(MAX(PageOrder), -1) + 2

FROM		mp_Pages

WHERE	SiteID = @SiteID
		AND ParentID = @ParentID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_Delete]
(
    @PageID int
)
AS

DELETE FROM
    mp_Pages

WHERE
    PageID = @PageID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_CountChildPages]

/*
Author:   			Joe Audette
Created: 			2013-01-02
Last Modified: 		2013-01-02
*/

@PageID			int,
@IncludePending bit

As

Select	Count(*)
From	[dbo].mp_Pages
Where	
	ParentID = @PageID
	AND ((IsPending = 0) OR (@IncludePending = 1))
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_CountBySite]

/*
Author:   			Joe Audette
Created: 			2011-02-06
Last Modified: 		2011-02-06
*/

@SiteID			int,
@IncludePending bit

As

Select	Count(*)
From	[dbo].mp_Pages
Where	
	SiteID = @SiteID
	AND ((IsPending = 0) OR (@IncludePending = 1))
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_CleanupOrphans]

AS

UPDATE mp_Pages

SET ParentGuid = '00000000-0000-0000-0000-000000000000',
	ParentID = -1

WHERE ParentID <> -1
AND ParentID NOT IN (SELECT PageID FROM mp_Pages)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[mp_ModuleSettings](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[ModuleID] [int] NOT NULL,
	[SettingName] [nvarchar](50) NOT NULL,
	[SettingValue] [nvarchar](max) NULL,
	[ControlType] [nvarchar](50) NULL,
	[RegexValidationExpression] [nvarchar](max) NULL,
	[SettingGuid] [uniqueidentifier] NULL,
	[ModuleGuid] [uniqueidentifier] NULL,
	[ControlSrc] [nvarchar](255) NULL,
	[SortOrder] [int] NOT NULL,
	[HelpKey] [nvarchar](255) NULL,
 CONSTRAINT [PK_mp_ModuleSettings] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF)
)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ModuleSetModId] ON [dbo].[mp_ModuleSettings] 
(
	[ModuleID] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
CREATE NONCLUSTERED INDEX [IX_mp_ModuleSetSetName] ON [dbo].[mp_ModuleSettings] 
(
	[SettingName] ASC
)WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_UpdateTimeStamp]
(
    @PageID           int,
    @LastModifiedUTC datetime
)
AS

UPDATE
    mp_Pages

SET
    LastModifiedUTC = @LastModifiedUTC

WHERE
    PageID = @PageID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_UpdatePageOrder]
(
    @PageID           int,
    @PageOrder        int
)
AS

UPDATE
    mp_Pages

SET
    PageOrder = @PageOrder

WHERE
    PageID = @PageID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_Update]

/*
Author:			Joe Audette
Last Modified:		2013-12-13

*/


@SiteID        		int,
@PageID           	int,
@ParentID		int,
@PageOrder        	int,
@PageName         	nvarchar(255),
@AuthorizedRoles 	nvarchar(max),
@EditRoles		nvarchar(max),
@DraftEditRoles		nvarchar(max),
@DraftApprovalRoles nvarchar(max),
@CreateChildPageRoles nvarchar(max),
@CreateChildDraftRoles nvarchar(max),
@RequireSSL		bit,
@ShowBreadcrumbs	bit,
@ShowChildPageBreadcrumbs bit,
@PageKeyWords	nvarchar(1000),
@PageDescription	nvarchar(255),
@PageEncoding	nvarchar(255),
@AdditionalMetaTags	nvarchar(255),
@UseUrl		bit,
@Url			nvarchar(255),
@OpenInNewWindow	bit,
@ShowChildPageMenu	bit,
@HideMainMenu	bit,
@Skin			nvarchar(100),
@IncludeInMenu	bit,
@MenuImage			nvarchar(50),
@PageTitle         	nvarchar(255),
@AllowBrowserCache	bit,
@ChangeFrequency	nvarchar(20),
@SiteMapPriority			nvarchar(10),
@LastModifiedUTC			datetime,
@ParentGuid uniqueidentifier,
@HideAfterLogin bit,
@CompiledMeta		nvarchar(max),
@CompiledMetaUtc	datetime,
@IncludeInSiteMap bit,
@IsClickable bit,
@ShowHomeCrumb bit,
@IsPending bit,
@CanonicalOverride nvarchar(255),
@IncludeInSearchMap bit,
@EnableComments bit,
@IncludeInChildSiteMap bit,
@ExpandOnSiteMap bit,
@PubTeamId uniqueidentifier,
@BodyCssClass nvarchar(50),
@MenuCssClass nvarchar(50),
@PublishMode int,
@PCreatedUtc DateTime,
@PCreatedBy uniqueidentifier,
@PLastModUtc DateTime,
@PLastModBy uniqueidentifier,
@PLastModFromIp nvarchar(36),
@MenuDesc nvarchar(max),
@LinkRel nvarchar(20),
@PageHeading nvarchar(255),
@ShowPageHeading bit,
@PubDateUtc DateTime


AS
UPDATE  [dbo].mp_Pages

SET
	ParentID = @ParentID,
    	PageOrder = @PageOrder,
    	PageName = @PageName,
		PageTitle = @PageTitle,
    	AuthorizedRoles = @AuthorizedRoles,
	EditRoles = @EditRoles,
	DraftEditRoles = @DraftEditRoles,
	DraftApprovalRoles = @DraftApprovalRoles,
	CreateChildPageRoles = @CreateChildPageRoles,
	CreateChildDraftRoles = @CreateChildDraftRoles,
    	RequireSSL = @RequireSSL,
	AllowBrowserCache = @AllowBrowserCache,
	ShowBreadcrumbs = @ShowBreadcrumbs,
	ShowChildBreadCrumbs = @ShowChildPageBreadcrumbs,
	PageKeyWords = @PageKeyWords,
	PageDescription = @PageDescription,
	PageEncoding = @PageEncoding,
	AdditionalMetaTags = @AdditionalMetaTags,
	UseUrl = @UseUrl,
	Url = @Url,
	OpenInNewWindow = @OpenInNewWindow,
	ShowChildPageMenu = @ShowChildPageMenu,
	HideMainMenu = @HideMainMenu,
	Skin = @Skin,
	IncludeInMenu = @IncludeInMenu,
	MenuImage = @MenuImage,
	ChangeFrequency = @ChangeFrequency,
	SiteMapPriority = @SiteMapPriority,
	LastModifiedUTC = @LastModifiedUTC,
	ParentGuid = @ParentGuid,
	HideAfterLogin = @HideAfterLogin,
	CompiledMeta = @CompiledMeta,
	CompiledMetaUtc = @CompiledMetaUtc,
	IncludeInSiteMap = @IncludeInSiteMap,
	IsClickable = @IsClickable,
	ShowHomeCrumb = @ShowHomeCrumb,
	IsPending = @IsPending,
	CanonicalOverride = @CanonicalOverride,
	IncludeInSearchMap = @IncludeInSearchMap,
	EnableComments = @EnableComments,
	IncludeInChildSiteMap = @IncludeInChildSiteMap,
	PubTeamId = @PubTeamId,
	BodyCssClass = @BodyCssClass,
	MenuCssClass = @MenuCssClass,
	ExpandOnSiteMap = @ExpandOnSiteMap,
	PublishMode = @PublishMode,
	PCreatedUtc = @PCreatedUtc,
	PCreatedBy = @PCreatedBy,
	PLastModUtc = @PLastModUtc,
	PLastModBy = @PLastModBy,
	PLastModFromIp = @PLastModFromIp,
	MenuDesc = @MenuDesc,
	LinkRel = @LinkRel,
	PageHeading = @PageHeading,
	ShowPageHeading = @ShowPageHeading,
	PubDateUtc = @PubDateUtc

WHERE
    PageID = @PageID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_Update]

/*
Author:   			Joe Audette
Created: 			2004-12-26
Last Modified: 		2013-04-23

*/
	
@ModuleID int, 
@ModuleDefID int, 
@ModuleTitle nvarchar(255), 
@AuthorizedEditRoles nvarchar(max), 
@DraftEditRoles nvarchar(max),
@DraftApprovalRoles nvarchar(max),
@CacheTime int, 
@ShowTitle bit ,
@EditUserID	int,
@AvailableForMyPage	bit,
@AllowMultipleInstancesOnMyPage	bit,
@Icon	nvarchar(255),
@HideFromAuth bit,
@HideFromUnAuth bit,
@ViewRoles nvarchar(max),
@IncludeInSearch bit,
@IsGlobal bit,
@HeadElement nvarchar(25),
@PublishMode int


AS
UPDATE 		[dbo].[mp_Modules] 

SET
			
			[ModuleDefID] = @ModuleDefID,
			
			[ModuleTitle] = @ModuleTitle,
			[AuthorizedEditRoles] = @AuthorizedEditRoles,
			[DraftEditRoles] = @DraftEditRoles,
			[DraftApprovalRoles] = @DraftApprovalRoles,
			[CacheTime] = @CacheTime,
			[ShowTitle] = @ShowTitle,
			EditUserID = @EditUserID,
			AvailableForMyPage = @AvailableForMyPage,
			AllowMultipleInstancesOnMyPage = @AllowMultipleInstancesOnMyPage,
			Icon = @Icon,
			HideFromAuth = @HideFromAuth,
			HideFromUnAuth = @HideFromUnAuth,
			ViewRoles = @ViewRoles,
			IncludeInSearch = @IncludeInSearch,
			IsGlobal = @IsGlobal,
			HeadElement = @HeadElement,
			PublishMode = @PublishMode
			
WHERE
			[ModuleID] = @ModuleID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_SelectPage]

/*
Author:			Joe Audette
Created:		2006-05-15
Last Modified:	2009-08-27

*/

@SiteID			int,
@ModuleDefID	int,
@Title nvarchar(255),
@PageNumber 	int,
@PageSize 		int,
@SortByModuleType	bit,
@SortByAuthor	bit



AS
DECLARE @PageLowerBound int
DECLARE @PageUpperBound int


SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1



CREATE TABLE #PageIndex 
(
	IndexID int IDENTITY (1, 1) NOT NULL,
	ModuleID int
)	


 IF @SortByModuleType = 1
	BEGIN
	    	INSERT INTO 	#PageIndex (ModuleID)

	    	SELECT 			m.ModuleID 
			FROM 			[dbo].mp_Modules m
			JOIN			[dbo].mp_ModuleDefinitions md
			ON				md.ModuleDefID = m.ModuleDefID
			WHERE 			m.SiteID = @SiteID
							AND ((m.ModuleDefID = @ModuleDefID) OR (@ModuleDefID = -1))
							AND ((m.ModuleTitle LIKE '%' + @Title + '%') OR (@Title = ''))
							AND md.IsAdmin = 0
				
			ORDER BY 		md.FeatureName, m.ModuleTitle

	END
 Else IF @SortByAuthor = 1
	BEGIN
		INSERT INTO 	#PageIndex (ModuleID)

	    	SELECT 			m.ModuleID 
			FROM 			[dbo].mp_Modules m
			JOIN			[dbo].mp_ModuleDefinitions md
			ON				md.ModuleDefID = m.ModuleDefID
			LEFT OUTER JOIN	mp_Users u
			ON				m.CreatedByUserID = u.UserID
			WHERE 			m.SiteID = @SiteID
							AND ((m.ModuleDefID = @ModuleDefID) OR (@ModuleDefID = -1))
							AND ((m.ModuleTitle LIKE '%' + @Title + '%') OR (@Title = ''))
							AND md.IsAdmin = 0
				
			ORDER BY 		u.[Name], m.ModuleTitle
	END
 ELSE
	BEGIN
	    	INSERT INTO 	#PageIndex (ModuleID)

	    	SELECT 			m.ModuleID 
			FROM 			[dbo].mp_Modules m
			JOIN			[dbo].mp_ModuleDefinitions md
			ON				md.ModuleDefID = m.ModuleDefID
			WHERE 			m.SiteID = @SiteID
							AND ((m.ModuleDefID = @ModuleDefID) OR (@ModuleDefID = -1))
							AND ((m.ModuleTitle LIKE '%' + @Title + '%') OR (@Title = ''))
							AND md.IsAdmin = 0
				
			ORDER BY 		m.ModuleTitle

	END




SELECT		m.*,
			md.FeatureName,
			md.ControlSrc,
			md.ResourceFile,
			u.[Name] As CreatedBy,
			(SELECT COUNT(pm.PageID) FROM [dbo].mp_PageModules pm WHERE pm.ModuleID = m.ModuleID) AS UseCount

FROM			mp_Modules m

JOIN			mp_ModuleDefinitions md
ON				md.ModuleDefID = m.ModuleDefID

LEFT OUTER JOIN	mp_Users u
ON				m.CreatedByUserID = u.UserID

JOIN			#PageIndex p
ON				m.ModuleID = p.ModuleID

WHERE 		
			p.IndexID > @PageLowerBound 
			AND p.IndexID < @PageUpperBound

ORDER BY		p.IndexID

DROP TABLE #PageIndex
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_SelectOneByPage]

/*
Author:   			Joe Audette
Created: 			2004-12-26
Last Modified: 		2011-03-08

*/

@ModuleID int,
@PageID		int

AS
SELECT  		m.*,
				pm.PageID,
				pm.ModuleOrder,
				pm.PaneName,
				pm.PublishBeginDate,
				pm.PublishEndDate,
				md.ControlSrc,
				md.FeatureName
    
FROM
    			mp_Modules m
  
INNER JOIN
    			mp_ModuleDefinitions md
ON 			m.ModuleDefID = md.ModuleDefID

INNER JOIN		mp_PageModules pm
ON				m.ModuleID = pm.ModuleID
    
WHERE   
    			pm.PageID = @PageID
				AND pm.ModuleID = @ModuleID
GO
 
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Pages_SelectPendingPageListPage]


/*
Author:   			Kevin Needham
Created: 			2009-06-19
Last Modified: 		2009-07-22
*/

@SiteGuid	uniqueidentifier,
@PageNumber 			int,
@PageSize 			int

AS

DECLARE @PageLowerBound int
DECLARE @PageUpperBound int


SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1



CREATE TABLE #PageIndex 
(
	IndexID int IDENTITY (1, 1) NOT NULL,
[Guid] UniqueIdentifier
)

BEGIN

INSERT INTO #PageIndex ( 
Guid
)

SELECT	[PageGuid]		
FROM	[dbo].[mp_Pages]		
WHERE	SiteGuid = @SiteGuid
AND		IsPending = 1

ORDER BY
		PageName 

END

SELECT  p.*,
		COALESCE(wip.Total,0) as WipCount    
FROM    [dbo].mp_Pages p
JOIN	#PageIndex idx
ON		p.[PageGuid] = idx.[Guid]
LEFT OUTER JOIN			
	(	SELECT	Count(*) as Total,
				pm.PageGuid
		FROM	[dbo].mp_PageModules pm
		INNER JOIN [dbo].mp_ContentWorkflow cw
			ON cw.ModuleGuid = pm.ModuleGuid			
		WHERE	[Status] Not In ('Cancelled','Approved') 
		GROUP BY pm.PageGuid ) as wip
	ON	wip.PageGuid = p.PageGuid
WHERE
		idx.IndexID > @PageLowerBound 
		AND idx.IndexID < @PageUpperBound
ORDER BY p.PageName
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_UpdatePage]

	
@OldPageID				int,
@NewPageID			int,
@ModuleID           int
    

AS
UPDATE
    mp_PageModules

SET
    PageID = @NewPageID,
	PageGuid = (SELECT TOP 1 PageGuid FROM mp_Pages WHERE PageID = @NewPageID)

WHERE
    ModuleID = @ModuleID
	AND PageID = @OldPageID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_UpdateModuleOrder]
(
	@PageID				int,
    @ModuleID           int,
    @ModuleOrder        int,
    @PaneName           nvarchar(50)
)
AS
UPDATE
    mp_PageModules

SET
    ModuleOrder = @ModuleOrder,
    PaneName    = @PaneName

WHERE
    ModuleID = @ModuleID
	AND PageID = @PageID
GO
 
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_PageModules_Update]

/*
Author:   			Joe Audette
Created: 			5/18/2006
Last Modified: 		5/18/2006

*/

@ModuleID			int,
@PageID				int,
@PaneName			nvarchar(50),
@ModuleOrder		int,
@PublishBeginDate	datetime,
@PublishEndDate		datetime

	
AS
UPDATE 	[dbo].[mp_PageModules] 
SET
				PaneName = @PaneName,
				ModuleOrder = @ModuleOrder,
				PublishBeginDate = @PublishBeginDate,
				PublishEndDate = @PublishEndDate

WHERE			ModuleID = @ModuleID
				AND PageID = @PageID
GO
 
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_PageModules_Insert]

/*
Author:   			Joe Audette
Created: 			5/18/2006
Last Modified: 		2008-01-27

*/

@PageGuid	uniqueidentifier,
@ModuleGuid uniqueidentifier,
@ModuleID			int,
@PageID				int,
@PaneName			nvarchar(50),
@ModuleOrder		int,
@PublishBeginDate	datetime,
@PublishEndDate		datetime

	
AS
INSERT INTO 	[dbo].[mp_PageModules] 
(
				PageGuid,
				ModuleGuid,
				ModuleID,
				PageID,
				PaneName,
				ModuleOrder,
				PublishBeginDate,
				PublishEndDate
				
) 

VALUES 
(
				@PageGuid,
				@ModuleGuid,
				@ModuleID,
				@PageID,
				@PaneName,
				@ModuleOrder,
				@PublishBeginDate,
				@PublishEndDate
				
				
)
SELECT @@IDENTITY
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_PageModules_DeleteByPage]
(
    @PageID int
)
AS

DELETE FROM
    mp_PageModules

WHERE
    PageID = @PageID
GO
 
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_PageModule_SelectByPage]

/*
Author:			Joe Audette
Created:		2007-09-01
Last Modified:	2009-07-19

*/
    
@PageID  	int


AS

SELECT pm.*,
m.ModuleTitle,
p.PageName,
p.UseUrl,
p.Url
		
FROM		[dbo].mp_PageModules pm

JOIN		[dbo].mp_Modules m
ON			pm.ModuleID = m.ModuleID

JOIN		[dbo].mp_Pages p
ON			pm.PageID = p.PageID
		
WHERE	pm.PageID = @PageID
GO
 
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_PageModule_SelectByModule]

/*
Author:			Joe Audette
Created:		2007-07-23
Last Modified:	2009-07-19

*/
    
@ModuleID  	int


AS

SELECT pm.*,
m.ModuleTitle,
p.PageName,
p.UseUrl,
p.Url
		
FROM		[dbo].mp_PageModules pm

JOIN		[dbo].mp_Modules m
ON			pm.ModuleID = m.ModuleID

JOIN		[dbo].mp_Pages p
ON			pm.PageID = p.PageID
		
WHERE	pm.ModuleID = @ModuleID
GO
 
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_PageModule_Exists]

/*
Author:			Joe Audette
Created:		5/18/2006
Last Modified:	5/18/2006

*/
    
@ModuleID  	int,
@PageID		int

AS
IF EXISTS (	SELECT 	ModuleID
		FROM		mp_PageModules
		WHERE	ModuleID = @ModuleID
				AND PageID = @PageID )
SELECT 1
ELSE
SELECT 0
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleSettings_Update]
(
	@ModuleGuid		uniqueidentifier,
    @ModuleID      int,
    @SettingName   nvarchar(50),
    @SettingValue  nvarchar(max)
)
AS

IF NOT EXISTS (
    SELECT 
        * 
    FROM 
        mp_ModuleSettings 
    WHERE 
        ModuleID = @ModuleID
      AND
        SettingName = @SettingName
)
INSERT INTO mp_ModuleSettings (
	SettingGuid,
	ModuleGuid,
    ModuleID,
    SettingName,
    SettingValue
) 
VALUES (
	newid(),
	@ModuleGuid,
    @ModuleID,
    @SettingName,
    @SettingValue
)
ELSE
UPDATE
    mp_ModuleSettings

SET
    SettingValue = @SettingValue

WHERE
    ModuleID = @ModuleID
  AND
    SettingName = @SettingName
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleSettings_SyncDefinitions]

AS


UPDATE ms
SET ms.RegexValidationExpression = mds.RegexValidationExpression,
ms.ControlSrc = mds.ControlSrc,
ms.ControlType = mds.ControlType,
ms.SortOrder = mds.SortOrder,
ms.HelpKey = mds.HelpKey
FROM mp_ModuleSettings ms
JOIN mp_Modules m
ON ms.ModuleID = m.ModuleID
JOIN mp_ModuleDefinitionSettings mds
ON ms.SettingName = mds.SettingName
AND m.ModuleDefId = mds.ModuleDefId
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleSettings_Select]
(
    @ModuleID int
)
AS

DECLARE @ModuleDefID int
SELECT @ModuleDefID = ModuleDefID 
FROM mp_Modules 
WHERE ModuleID = @ModuleID

SELECT 	ms.ID,
		ms.ModuleID,
		ms.SettingName,
		ms.SettingValue,
		mds.ModuleDefID,
		mds.FeatureGuid,
		mds.ResourceFile,
		mds.ControlType,
		mds.RegexValidationExpression,
		mds.ControlSrc,
		mds.SortOrder,
		mds.HelpKey,
		mds.GroupName

FROM		mp_ModuleSettings ms

JOIN		mp_ModuleDefinitionSettings mds
ON			mds.ModuleDefID = @ModuleDefID
			AND mds.SettingName = ms.SettingName

WHERE	ms.ModuleID = @ModuleID

ORDER BY mds.SortOrder, mds.GroupName
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleSettings_Insert]

/*
Author:			Joe Audette
Created:		2005-06-09
Last Modified:	2010-07-01

*/


@SettingGuid		uniqueidentifier,
@ModuleGuid		uniqueidentifier,
@ModuleID			int,
@SettingName			nvarchar(50),
@SettingValue			nvarchar(max),
@ControlType			nvarchar(50),
@RegexValidationExpression 	nvarchar(max),
@ControlSrc			nvarchar(255),
@HelpKey			nvarchar(255),
@SortOrder			int




AS

INSERT INTO 	mp_ModuleSettings
(
			SettingGuid,
			ModuleGuid,
			ModuleID,
			SettingName,
			SettingValue,
			ControlType,
			RegexValidationExpression,
			ControlSrc,
			HelpKey,
			SortOrder
)

VALUES
(
			@SettingGuid,
			@ModuleGuid,
			@ModuleID,
			@SettingName,
			@SettingValue,
			@ControlType,
			@RegexValidationExpression,
			@ControlSrc,
			@HelpKey,
			@SortOrder
)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleSettings_Delete]

/*
Author:			Joe Audette
Created:		1/1/2005
Last Modified:		1/1/2005

*/

@ModuleID		int

AS

DELETE FROM mp_ModuleSettings

WHERE	ModuleID = @ModuleID
GO
 
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ModuleSettings_CreateDefaultSettings]

/*
Author:			Joe Audette
Created:		1/1/2005
Last Modified:	2008-01-29

*/



@ModuleID		int


AS

INSERT INTO 	mp_ModuleSettings
(
			ModuleID,
			SettingName,
			SettingValue,
			ControlType,
			RegexValidationExpression,
			ModuleGuid,
			SettingGuid,
			ControlSrc,
			HelpKey,
			SortOrder
)

SELECT		m.ModuleID,
			ds.SettingName,
			ds.SettingValue,
			ds.ControlType,
			ds.RegexValidationExpression,
			m.[Guid],
			newid(),
			ds.ControlSrc,
			ds.HelpKey,
			ds.SortOrder


FROM			mp_Modules m

JOIN			mp_ModuleDefinitionSettings ds
ON			ds.ModuleDefID = m.ModuleDefID

WHERE		m.ModuleID = @ModuleID

ORDER BY		ds.[ID]
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_SelectGlobalPage]

/*
Author:			Joe Audette
Created:		2010-12-30
Last Modified:	2011-01-21

*/

@SiteID			int,
@ModuleDefID	int,
@PageID int,
@PageNumber 	int,
@PageSize 		int



AS
DECLARE @PageLowerBound int
DECLARE @PageUpperBound int


SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1



CREATE TABLE #PageIndex 
(
	IndexID int IDENTITY (1, 1) NOT NULL,
	ModuleID int
)	


 
	BEGIN
	    	INSERT INTO 	#PageIndex (ModuleID)

	    	SELECT 			m.ModuleID 
			FROM 			[dbo].mp_Modules m
			JOIN			[dbo].mp_ModuleDefinitions md
			ON				md.ModuleDefID = m.ModuleDefID
			WHERE 			m.SiteID = @SiteID
							AND ((m.ModuleDefID = @ModuleDefID) OR (@ModuleDefID = -1))
							AND m.IsGlobal = 1
							AND m.ModuleID NOT IN (SELECT ModuleID FROM mp_PageModules WHERE PageID = @PageID)
				
			ORDER BY 		m.ModuleTitle

	END




SELECT		m.*,
			md.FeatureName,
			md.ControlSrc,
			md.ResourceFile,
			u.[Name] As CreatedBy,
			(SELECT COUNT(pm.PageID) FROM [dbo].mp_PageModules pm WHERE pm.ModuleID = m.ModuleID) AS UseCount

FROM			mp_Modules m

JOIN			mp_ModuleDefinitions md
ON				md.ModuleDefID = m.ModuleDefID

LEFT OUTER JOIN	mp_Users u
ON				m.CreatedByUserID = u.UserID

JOIN			#PageIndex p
ON				m.ModuleID = p.ModuleID

WHERE 		
			p.IndexID > @PageLowerBound 
			AND p.IndexID < @PageUpperBound

ORDER BY		p.IndexID

DROP TABLE #PageIndex
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_SelectBySite]

/*
Author:				Joe Audette
Created:			2009-01-04
Last Modified:		2011-11-12

*/

@SiteID		int,
@FeatureGuid uniqueidentifier


AS
SELECT  		m.ModuleID,
				m.ModuleTitle,
				m.AuthorizedEditRoles,
				m.EditUserID,
				p.Url,
				p.PageName,
				p.UseUrl,
				p.PageID,
				p.EditRoles
    
FROM
    			[dbo].mp_Modules m
  
JOIN		[dbo].mp_ModuleDefinitions md
ON 			m.ModuleDefID = md.ModuleDefID

JOIN		[dbo].mp_PageModules pm
ON				m.ModuleID = pm.ModuleID

JOIN		[dbo].mp_Pages p
ON			pm.PageID = p.PageID
    
WHERE   
    			md.Guid = @FeatureGuid
				AND m.SiteId=@SiteID
		
    
ORDER BY p.PageName, m.ModuleTitle
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_SelectByPage]

/*
Author:				Joe Audette
Created:			2004-12-26
Last Modified:		2010-11-10

*/

@PageID		int,
@CurrentTime dateTime


AS
SELECT  		m.*,
				pm.PageID,
				pm.ModuleOrder,
				pm.PaneName,
				pm.PublishBeginDate,
				pm.PublishEndDate,
				md.ControlSrc,
				md.FeatureName,
				md.[Guid] AS FeatureGuid
    
FROM
    			mp_Modules m
  
INNER JOIN
    			mp_ModuleDefinitions md
ON 			m.ModuleDefID = md.ModuleDefID

INNER JOIN		mp_PageModules pm
ON				m.ModuleID = pm.ModuleID
    
WHERE   
    			pm.PageID = @PageID
				AND pm.PublishBeginDate <= @CurrentTime
				AND	(
					(pm.PublishEndDate IS NULL)
					OR
					(pm.PublishEndDate > @CurrentTime)
					)
		
    
ORDER BY
    			pm.ModuleOrder
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_Insert]

/*
Author:   			Joe Audette
Created: 			2004-12-26
Last Modified: 		2013-04-23

*/

@PageID int,
@SiteID		int,
@ModuleDefID int,
@ModuleOrder int,
@PaneName nvarchar(50),
@ModuleTitle nvarchar(255),
@AuthorizedEditRoles nvarchar(max),
@DraftEditRoles nvarchar(max),
@DraftApprovalRoles nvarchar(max),
@CacheTime int,
@ShowTitle bit,
@AvailableForMyPage	bit,
@CreatedByUserID	int,
@CreatedDate		datetime,
@AllowMultipleInstancesOnMyPage	bit,
@Icon	nvarchar(255),
@Guid	uniqueidentifier,
@FeatureGuid uniqueidentifier,
@SiteGuid	uniqueidentifier,
@HideFromAuth bit,
@HideFromUnAuth bit,
@ViewRoles nvarchar(max),
@HeadElement nvarchar(25),
@PublishMode int

	
AS
DECLARE @ModuleID int

INSERT INTO 	[dbo].[mp_Modules] 
(
				SiteID,
				SiteGuid,
				[ModuleDefID],
				[ModuleTitle],
				[AuthorizedEditRoles],
				[DraftEditRoles],
				[DraftApprovalRoles],
				[CacheTime],
				[ShowTitle],
				AvailableForMyPage,
				AllowMultipleInstancesOnMyPage,
				Icon,
				CreatedByUserID,
				CreatedDate,
				[Guid],
				FeatureGuid,
				HideFromAuth,
				HideFromUnAuth,
				ViewRoles,
				IncludeInSearch,
				IsGlobal,
				HeadElement,
				PublishMode
				
) 

VALUES 
(
				@SiteID,
				@SiteGuid,
				@ModuleDefID,
				@ModuleTitle,
				@AuthorizedEditRoles,
				@DraftEditRoles,
				@DraftApprovalRoles,
				@CacheTime,
				@ShowTitle,
				@AvailableForMyPage,
				@AllowMultipleInstancesOnMyPage,
				@Icon,
				@CreatedByUserID,
				@CreatedDate,
				@Guid,
				@FeatureGuid,
				@HideFromAuth,
				@HideFromUnAuth,
				@ViewRoles,
				1,
				0,
				@HeadElement,
				@PublishMode
				
)
SELECT @ModuleID =  @@IDENTITY

IF @PageID > -1
BEGIN

DECLARE @PageGuid uniqueidentifier
SET @PageGuid = (SELECT TOP 1 PageGuid FROM [dbo].mp_Pages WHERE PageID = @PageID)

INSERT INTO 	[dbo].[mp_PageModules] 
(
				[PageID],
				[ModuleID],
				[ModuleOrder],
				[PaneName],
				[PublishBeginDate],
				PageGuid,
				ModuleGuid
				
) 

VALUES 
(
				@PageID,
				@ModuleID,
				@ModuleOrder,
				@PaneName,
				@CreatedDate,
				@PageGuid,
				@Guid
				
				
)
END


SELECT @ModuleID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_GetGlobalCount]

/*
Author:   			Joe Audette
Created: 			2010-12-30
Last Modified: 		2011-01-21
*/

@SiteID			int,
@ModuleDefID	int,
@PageID int

AS

SELECT COUNT(*) 
FROM [dbo].[mp_Modules] m
JOIN			[dbo].mp_ModuleDefinitions md
ON				md.ModuleDefID = m.ModuleDefID

WHERE 			m.SiteID = @SiteID
				AND ((m.ModuleDefID = @ModuleDefID) OR (@ModuleDefID = -1))
				AND m.IsGlobal = 1
				AND m.ModuleID NOT IN (SELECT ModuleID FROM mp_PageModules WHERE PageID = @PageID)
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_DeleteInstance]

/*
Author:   			Joe Audette
Created: 			5/18/2006
Last Modified: 		5/18/2006


*/

@ModuleID int,
@PageID		int

AS
DELETE FROM [dbo].[mp_PageModules]
WHERE ModuleID = @ModuleID AND PageID = @PageID
GO
 
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_Delete]

/*
Author:   			Joe Audette
Created: 			12/26/2004
Last Modified: 		6/28/2006


*/

@ModuleID int

AS

DELETE FROM [dbo].[mp_PageModules]
WHERE ModuleID = @ModuleID

DELETE FROM [dbo].[mp_Modules]
WHERE ModuleID = @ModuleID
GO
ALTER TABLE [dbo].[mp_Category] ADD  CONSTRAINT [DF_mp_Category_Guid]  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[mp_Category] ADD  CONSTRAINT [DF_mp_Category_ItemCount]  DEFAULT ((0)) FOR [ItemCount]
GO
ALTER TABLE [dbo].[mp_Category] ADD  CONSTRAINT [DF_mp_Category_CreatedUtc]  DEFAULT (getutcdate()) FOR [CreatedUtc]
GO
ALTER TABLE [dbo].[mp_Category] ADD  CONSTRAINT [DF_mp_Category_ModifiedUtc]  DEFAULT (getutcdate()) FOR [ModifiedUtc]
GO
ALTER TABLE [dbo].[mp_CategoryItem] ADD  CONSTRAINT [DF_mp_CategoryItem_Guid]  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[mp_Comments] ADD  CONSTRAINT [DF_mp_Comments_Guid]  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[mp_Comments] ADD  CONSTRAINT [DF_mp_Comments_ParentGuid]  DEFAULT ('00000000-0000-0000-0000-000000000000') FOR [ParentGuid]
GO
ALTER TABLE [dbo].[mp_Comments] ADD  CONSTRAINT [DF_mp_Comments_FeatureGuid]  DEFAULT ('00000000-0000-0000-0000-000000000000') FOR [FeatureGuid]
GO
ALTER TABLE [dbo].[mp_Comments] ADD  CONSTRAINT [DF_mp_Comments_ModuleGuid]  DEFAULT ('00000000-0000-0000-0000-000000000000') FOR [ModuleGuid]
GO
ALTER TABLE [dbo].[mp_Comments] ADD  CONSTRAINT [DF_mp_Comments_UserGuid]  DEFAULT ('00000000-0000-0000-0000-000000000000') FOR [UserGuid]
GO
ALTER TABLE [dbo].[mp_Comments] ADD  CONSTRAINT [DF_mp_Comments_CreatedUtc]  DEFAULT (getutcdate()) FOR [CreatedUtc]
GO
ALTER TABLE [dbo].[mp_Comments] ADD  CONSTRAINT [DF_mp_Comments_LastModUtc]  DEFAULT (getutcdate()) FOR [LastModUtc]
GO
ALTER TABLE [dbo].[mp_Comments] ADD  CONSTRAINT [DF_Table_1_Approved]  DEFAULT ((1)) FOR [ModerationStatus]
GO
ALTER TABLE [dbo].[mp_Comments] ADD  CONSTRAINT [DF_Table_1_ApprvedBy]  DEFAULT ('00000000-0000-0000-0000-000000000000') FOR [ModeratedBy]
GO
ALTER TABLE [dbo].[mp_ContentRating] ADD  CONSTRAINT [DF_mp_ContentRating_CreatedUtc]  DEFAULT (getutcdate()) FOR [CreatedUtc]
GO
ALTER TABLE [dbo].[mp_ContentRating] ADD  CONSTRAINT [DF_mp_ContentRating_LastModUtc]  DEFAULT (getutcdate()) FOR [LastModUtc]
GO
ALTER TABLE [dbo].[mp_ModuleDefinitions] ADD  CONSTRAINT [DF_mp_ModuleDefinitions_SortOrder]  DEFAULT ((500)) FOR [SortOrder]
GO
ALTER TABLE [dbo].[mp_ModuleDefinitions] ADD  CONSTRAINT [DF_mp_ModuleDefinitions_IsAdmin]  DEFAULT ((0)) FOR [IsAdmin]
GO
ALTER TABLE [dbo].[mp_ModuleDefinitions] ADD  CONSTRAINT [DF_mp_ModuleDefinitions_DefaultCacheTime]  DEFAULT ((0)) FOR [DefaultCacheTime]
GO
ALTER TABLE [dbo].[mp_ModuleDefinitions] ADD  CONSTRAINT [DF_mp_ModuleDefinitions_Guid]  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[mp_ModuleDefinitionSettings] ADD  DEFAULT ((100)) FOR [SortOrder]
GO
ALTER TABLE [dbo].[mp_Modules] ADD  CONSTRAINT [DF_mp_Modules_ShowTitle]  DEFAULT ((1)) FOR [ShowTitle]
GO
ALTER TABLE [dbo].[mp_Modules] ADD  CONSTRAINT [DF_mp_Modules_EditUserID]  DEFAULT ((0)) FOR [EditUserID]
GO
ALTER TABLE [dbo].[mp_Modules] ADD  CONSTRAINT [DF_mp_Modules_AvailableForMyPage]  DEFAULT ((0)) FOR [AvailableForMyPage]
GO
ALTER TABLE [dbo].[mp_Modules] ADD  CONSTRAINT [DF_mp_Modules_AllowMultipleInstancesOnMyPage]  DEFAULT ((1)) FOR [AllowMultipleInstancesOnMyPage]
GO
ALTER TABLE [dbo].[mp_Modules] ADD  CONSTRAINT [DF_mp_Modules_CreatedByUserID]  DEFAULT ((-1)) FOR [CreatedByUserID]
GO
ALTER TABLE [dbo].[mp_Modules] ADD  CONSTRAINT [DF_mp_Modules_CreatedDate]  DEFAULT (getdate()) FOR [CreatedDate]
GO
ALTER TABLE [dbo].[mp_Modules] ADD  CONSTRAINT [DF_mp_Modules_CountOfUseOnMyPage]  DEFAULT ((0)) FOR [CountOfUseOnMyPage]
GO
ALTER TABLE [dbo].[mp_Modules] ADD  DEFAULT ((0)) FOR [HideFromUnAuth]
GO
ALTER TABLE [dbo].[mp_Modules] ADD  DEFAULT ((0)) FOR [HideFromAuth]
GO
ALTER TABLE [dbo].[mp_ModuleSettings] ADD  DEFAULT ((100)) FOR [SortOrder]
GO
ALTER TABLE [dbo].[mp_PageModules] ADD  CONSTRAINT [DF_mp_PageModules_ModuleOrder]  DEFAULT ((3)) FOR [ModuleOrder]
GO
ALTER TABLE [dbo].[mp_PageModules] ADD  CONSTRAINT [DF_mp_PageModules_PublishBeginDate]  DEFAULT (getdate()) FOR [PublishBeginDate]
GO
ALTER TABLE [dbo].[mp_Pages] ADD  CONSTRAINT [DF_mp_Pages_ParentID]  DEFAULT ((-1)) FOR [ParentID]
GO
ALTER TABLE [dbo].[mp_Pages] ADD  CONSTRAINT [DF_mp_Pages_RequireSSL]  DEFAULT ((0)) FOR [RequireSSL]
GO
ALTER TABLE [dbo].[mp_Pages] ADD  CONSTRAINT [DF_mp_Pages_AllowBrowserCache]  DEFAULT ((1)) FOR [AllowBrowserCache]
GO
ALTER TABLE [dbo].[mp_Pages] ADD  CONSTRAINT [DF_mp_Pages_ShowBreadcrumbs]  DEFAULT ((0)) FOR [ShowBreadcrumbs]
GO
ALTER TABLE [dbo].[mp_Pages] ADD  CONSTRAINT [DF_mp_Pages_UseLinkInsteadOfPage]  DEFAULT ((0)) FOR [UseUrl]
GO
ALTER TABLE [dbo].[mp_Pages] ADD  CONSTRAINT [DF_mp_Pages_OpenInNewWindow]  DEFAULT ((0)) FOR [OpenInNewWindow]
GO
ALTER TABLE [dbo].[mp_Pages] ADD  CONSTRAINT [DF_mp_Pages_ShowChildPageMenu]  DEFAULT ((0)) FOR [ShowChildPageMenu]
GO
ALTER TABLE [dbo].[mp_Pages] ADD  CONSTRAINT [DF_mp_Pages_ShowChildBreadCrumbs]  DEFAULT ((0)) FOR [ShowChildBreadCrumbs]
GO
ALTER TABLE [dbo].[mp_Pages] ADD  CONSTRAINT [DF_mp_Pages_HideMainMenu]  DEFAULT ((0)) FOR [HideMainMenu]
GO
ALTER TABLE [dbo].[mp_Pages] ADD  CONSTRAINT [DF_mp_Pages_IncludeInMenu]  DEFAULT ((1)) FOR [IncludeInMenu]
GO
ALTER TABLE [dbo].[mp_Pages] ADD  CONSTRAINT [DF_mp_Pages_PageGuid]  DEFAULT (newid()) FOR [PageGuid]
GO
ALTER TABLE [dbo].[mp_Pages] ADD  CONSTRAINT [DF_mp_Pages_ParentGuid]  DEFAULT ('00000000-0000-0000-0000-000000000000') FOR [ParentGuid]
GO
ALTER TABLE [dbo].[mp_Pages] ADD  CONSTRAINT [DF_mp_Pages_HideAfterLogin]  DEFAULT ((0)) FOR [HideAfterLogin]
GO
ALTER TABLE [dbo].[mp_Pages] ADD  DEFAULT ((0)) FOR [IsPending]
GO
ALTER TABLE [dbo].[mp_Pages] ADD  DEFAULT (getutcdate()) FOR [PCreatedUtc]
GO
ALTER TABLE [dbo].[mp_Pages] ADD  DEFAULT (getutcdate()) FOR [PLastModUtc]
GO
ALTER TABLE [dbo].[mp_Pages] ADD  DEFAULT ((1)) FOR [ShowPageHeading]
GO
ALTER TABLE [dbo].[mp_Pages] ADD  DEFAULT (getutcdate()) FOR [PubDateUtc]
GO
ALTER TABLE [dbo].[mp_Tag] ADD  CONSTRAINT [DF_mp_Tag_Guid]  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[mp_Tag] ADD  CONSTRAINT [DF_mp_Tag_CreatedUtc]  DEFAULT (getutcdate()) FOR [CreatedUtc]
GO
ALTER TABLE [dbo].[mp_Tag] ADD  CONSTRAINT [DF_mp_Tag_ItemCount]  DEFAULT ((0)) FOR [ItemCount]
GO
ALTER TABLE [dbo].[mp_TagItem] ADD  CONSTRAINT [DF_mp_TagItem_Guid]  DEFAULT (newid()) FOR [Guid]
GO
ALTER TABLE [dbo].[mp_Modules]  WITH NOCHECK ADD  CONSTRAINT [FK_Modules_ModuleDefinitions] FOREIGN KEY([ModuleDefID])
REFERENCES [dbo].[mp_ModuleDefinitions] ([ModuleDefID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[mp_Modules] CHECK CONSTRAINT [FK_Modules_ModuleDefinitions]
GO
ALTER TABLE [dbo].[mp_ModuleSettings]  WITH NOCHECK ADD  CONSTRAINT [FK_ModuleSettings_Modules] FOREIGN KEY([ModuleID])
REFERENCES [dbo].[mp_Modules] ([ModuleID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[mp_ModuleSettings] CHECK CONSTRAINT [FK_ModuleSettings_Modules]
GO
ALTER TABLE [dbo].[mp_PageModules]  WITH CHECK ADD  CONSTRAINT [FK_mp_PageModules_mp_Modules] FOREIGN KEY([ModuleID])
REFERENCES [dbo].[mp_Modules] ([ModuleID])
GO
ALTER TABLE [dbo].[mp_PageModules] CHECK CONSTRAINT [FK_mp_PageModules_mp_Modules]
GO
ALTER TABLE [dbo].[mp_PageModules]  WITH CHECK ADD  CONSTRAINT [FK_mp_PageModules_mp_PageModules] FOREIGN KEY([PageID])
REFERENCES [dbo].[mp_Pages] ([PageID])
GO
ALTER TABLE [dbo].[mp_PageModules] CHECK CONSTRAINT [FK_mp_PageModules_mp_PageModules]
GO
ALTER TABLE [dbo].[mp_Pages]  WITH NOCHECK ADD  CONSTRAINT [FK_Tabs_Portals] FOREIGN KEY([SiteID])
REFERENCES [dbo].[mp_Sites] ([SiteID])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[mp_Pages] CHECK CONSTRAINT [FK_Tabs_Portals]
GO

